var Dependencies,Dialogs,DownloadUpload,Group,Groups,Overlay,Storage,addToCache,cacheLookup,createFontStyleString,createStyleString,drawHTMLCache,editor,exportPage,formatContentForWiki,getAPIPage,getIndexPage,getPageContent,getPageData,getPageMetadata,getPageTimestamp,grouperHTML,grouperInfo,htmlToImage,importPage,installClickListener,keyboardShortcutsWorkaround,login,markUsed,maybeSetupTestRecorder,moreMenuItems,moreToolbarItems,plugin,prepareHTML,pruneCache,setAPIPage,setIndexPage,styleSheet,styleSheetURL,hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1},bind=function(t,e){return function(){return t.apply(e,arguments)}},slice=[].slice;JSON.equals=function(t,e){var n,o,i,r,s;if(t instanceof Object!=e instanceof Object)return!1;if(t instanceof Array!=e instanceof Array)return!1;if(!(t instanceof Object))return t===e;if(r=Object.keys(t).sort(),s=Object.keys(e).sort(),JSON.stringify(r)!==JSON.stringify(s))return!1;for(n=0,i=r.length;n<i;n++)if(o=r[n],!JSON.equals(t[o],e[o]))return!1;return!0},window.installDOMUtilitiesIn=function(t){var e;return t.Node.prototype.address=function(t){var e;return null==t&&(t=null),this===t?[]:this.parentNode?null===(e=this.parentNode.address(t))?null:e.concat([this.indexInParent()]):t?null:[]},t.Node.prototype.indexInParent=function(){return this.parentNode?Array.prototype.slice.apply(this.parentNode.childNodes).indexOf(this):-1},t.Node.prototype.index=function(t){var e;if(!(t instanceof Array))throw Error("Node address function requires an array");if(0===t.length)return this;if("number"==typeof t[0])return null!=(e=this.childNodes[t[0]])?e.index(t.slice(1)):void 0},t.Node.prototype.toJSON=function(e){var n,o,i,r,s,l;if(null==e&&(e=!0),this instanceof t.Text)return this.textContent;if(this instanceof t.Comment)return e?{comment:!0,content:this.textContent}:{m:!0,n:this.textContent};if(!(this instanceof t.Element))throw Error("Cannot serialize this node: "+this);if(l={tagName:this.tagName},this.attributes.length)for(l.attributes={},i=0,r=(s=this.attributes).length;i<r;i++)n=s[i],l.attributes[n.name]=n.value;return this.childNodes.length&&(l.children=function(){var t,n,i,r;for(r=[],t=0,n=(i=this.childNodes).length;t<n;t++)o=i[t],r.push(o.toJSON(e));return r}.call(this)),e||(l.t=l.tagName,delete l.tagName,l.a=l.attributes,delete l.attributes,l.c=l.children,delete l.children),l},t.Node.fromJSON=function(e){var n,o,i,r,s,l,a,u;if("string"==typeof e)return t.document.createTextNode(e);if("comment"in e&&e.comment)return t.document.createComment(e.content);if("m"in e&&e.m)return t.document.createComment(e.n);if(!1 in e&&!1 in e)throw Error("Object has no t[agName]: "+this);if(a=t.document.createElement(e.tagName||e.t),n=e.attributes||e.a)for(s in n)hasProp.call(n,s)&&(u=n[s],a.setAttribute(s,u));if(i=e.children||e.c)for(r=0,l=i.length;r<l;r++)o=i[r],a.appendChild(Node.fromJSON(o));return a},t.Node.prototype.nextLeaf=function(t){var e;for(null==t&&(t=null),e=this;e&&e!==t&&!e.nextSibling;)e=e.parentNode;if(e===t)return null;if(!(e=null!=e?e.nextSibling:void 0))return null;for(;e.childNodes.length>0;)e=e.childNodes[0];return e},t.Node.prototype.previousLeaf=function(t){var e;for(null==t&&(t=null),e=this;e&&e!==t&&!e.previousSibling;)e=e.parentNode;if(e===t)return null;if(!(e=null!=e?e.previousSibling:void 0))return null;for(;e.childNodes.length>0;)e=e.childNodes[e.childNodes.length-1];return e},t.Node.prototype.nextTextNode=function(e){var n;return null==e&&(e=null),(n=this.nextLeaf(e))instanceof t.Text?n:null!=n?n.nextTextNode(e):void 0},t.Node.prototype.previousTextNode=function(e){var n;return null==e&&(e=null),(n=this.previousLeaf(e))instanceof t.Text?n:null!=n?n.previousTextNode(e):void 0},t.Node.prototype.firstLeafInside=function(){var t,e;return(null!=(t=this.childNodes)&&null!=(e=t[0])?e.firstLeafInside():void 0)||this},t.Node.prototype.lastLeafInside=function(){var t,e;return(null!=(t=this.childNodes)&&null!=(e=t[this.childNodes.length-1])?e.lastLeafInside():void 0)||this},t.Node.prototype.remove=function(){var t;return null!=(t=this.parentNode)?t.removeChild(this):void 0},t.Element.prototype.hasClass=function(t){var e,n;return(e=null!=(n=this.getAttribute("class"))?n.split(/\s+/):void 0)&&indexOf.call(e,t)>=0},t.Element.prototype.addClass=function(t){var e,n;return e=(null!=(n=this.getAttribute("class"))?n.split(/\s+/):void 0)||[],indexOf.call(e,t)<0&&e.push(t),this.setAttribute("class",e.join(" "))},t.Element.prototype.removeClass=function(t){var e,n,o;return n=(null!=(o=this.getAttribute("class"))?o.split(/\s+/):void 0)||[],(n=function(){var o,i,r;for(r=[],o=0,i=n.length;o<i;o++)(e=n[o])!==t&&r.push(e);return r}()).length>0?this.setAttribute("class",n.join(" ")):this.removeAttribute("class")},t.document.nodeFromPoint=function(e,n){var o,i,r,s,l,a,u,c,d,p;for(i=0,s=(d=(o=t.document.elementFromPoint(e,n)).childNodes).length;i<s;i++)if((a=d[i])instanceof t.Text)for((u=t.document.createRange()).selectNode(a),r=0,l=(p=u.getClientRects()).length;r<l;r++)if((c=p[r]).left<e&&e<c.right&&c.top<n&&n<c.bottom)return a;return o},t.strictNodeOrder=function(t,e){var n;return n=t.compareDocumentPosition(e),Node.DOCUMENT_POSITION_FOLLOWING&n&&!(Node.DOCUMENT_POSITION_CONTAINED_BY&n)},t.strictNodeComparator=function(t,e){return t===e?0:strictNodeOrder(t,e)?-1:1},t.Range.prototype.extendByCharacters=function(e){var n,o,i,r;if(0===e)return!0;if(e>0){if(!(this.endContainer instanceof t.Text)){if(this.endOffset>0?o=this.endContainer.childNodes[this.endOffset-1].nextTextNode(t.document.body):(o=this.endContainer.firstLeafInside())instanceof t.Text||(o=o.nextTextNode(t.document.body)),!o)return!1;this.setEnd(o,0)}if(n=this.endContainer.length-this.endOffset,e<=n)return this.setEnd(this.endContainer,this.endOffset+e),!0;if(o=this.endContainer.nextTextNode(t.document.body))return this.setEnd(o,0),this.extendByCharacters(e-n)}else if(e<0){if(!(this.startContainer instanceof t.Text)){if(this.startOffset>0?i=this.startContainer.childNodes[this.startOffset-1].previousTextNode(t.document.body):(i=this.startContainer.lastLeafInside())instanceof t.Text||(i=i.previousTextNode(t.document.body)),!i)return!1;this.setStart(i,0)}if(-e<=this.startOffset)return this.setStart(this.startContainer,this.startOffset+e),!0;if(i=this.startContainer.previousTextNode(t.document.body))return r=e+this.startOffset,this.setStart(i,i.length),this.extendByCharacters(r)}return!1},e=function(t){return!/\s/.test(t)},t.Range.prototype.firstCharacter=function(){return this.toString().charAt(0)},t.Range.prototype.lastCharacter=function(){return this.toString().charAt(this.toString().length-1)},t.Range.prototype.extendByWords=function(t){var n,o,i;if(o=this.cloneRange(),this.includeWholeWords(),0===t)return!0;if(t>0){if(!this.equals(o))return this.extendByWords(t-1);for(i=!1;0===this.toString().length||!i||e(this.lastCharacter());){if(n=this.cloneRange(),!this.extendByCharacters(1))return i&&1===t;e(this.lastCharacter())&&(i=!0)}return this.setStart(n.startContainer,n.startOffset),this.setEnd(n.endContainer,n.endOffset),this.extendByWords(t-1)}if(t<0){if(!this.equals(o))return this.extendByWords(t+1);for(i=!1;0===this.toString().length||!i||e(this.firstCharacter());){if(n=this.cloneRange(),!this.extendByCharacters(-1))return i&&-1===t;e(this.firstCharacter())&&(i=!0)}return this.setStart(n.startContainer,n.startOffset),this.setEnd(n.endContainer,n.endOffset),this.extendByWords(t+1)}return!1},t.Range.prototype.equals=function(t){return this.startContainer===t.startContainer&&this.endContainer===t.endContainer&&this.startOffset===t.startOffset&&this.endOffset===t.endOffset},t.Range.prototype.includeWholeWords=function(){for(var t;(0===this.toString().length||e(this.firstCharacter()))&&(t=this.cloneRange(),this.extendByCharacters(-1)););for(this.setStart(t.startContainer,t.startOffset),this.setEnd(t.endContainer,t.endOffset);(0===this.toString().length||e(this.lastCharacter()))&&(t=this.cloneRange(),this.extendByCharacters(1)););return this.setStart(t.startContainer,t.startOffset),this.setEnd(t.endContainer,t.endOffset)}},installDOMUtilitiesIn(window),CanvasRenderingContext2D.prototype.bezierArrow=function(t,e,n,o,i,r,s,l,a){var u,c,d,p,h;return null==a&&(a=10),h=function(t,e){var n;return n=Math.sqrt(t*t+e*e)||1,{x:t/n,y:e/n}},this.beginPath(),this.moveTo(t,e),this.bezierCurveTo(n,o,i,r,s,l),d={x:this.applyBezier(t,n,i,s,.9),y:this.applyBezier(e,o,r,l,.9)},p={x:s-d.x,y:l-d.y},c=h(p.x,p.y),c.x*=.7*a,c.y*=a,u={x:c.y,y:-c.x},this.moveTo(s-u.x-c.x,l-u.y-c.y),this.lineTo(s,l),this.lineTo(s+u.x-c.x,l+u.y-c.y)},CanvasRenderingContext2D.prototype.applyBezier=function(t,e,n,o,i){return Math.pow(1-i,3)*t+3*Math.pow(1-i,2)*i*e+3*(1-i)*Math.pow(i,2)*n+Math.pow(i,3)*o},CanvasRenderingContext2D.prototype.roundedRect=function(t,e,n,o,i){return this.beginPath(),this.moveTo(t+i,e),this.lineTo(n-i,e),this.arcTo(n,e,n,e+i,i),this.lineTo(n,o-i),this.arcTo(n,o,n-i,o,i),this.lineTo(t+i,o),this.arcTo(t,o,t,o-i,i),this.lineTo(t,e+i),this.arcTo(t,e,t+i,e,i),this.closePath()},CanvasRenderingContext2D.prototype.roundedZone=function(t,e,n,o,i,r,s,l,a){return this.beginPath(),this.moveTo(t+a,e),this.lineTo(this.canvas.width-l,e),this.lineTo(this.canvas.width-l,r),this.lineTo(n,r),this.lineTo(n,o-a),this.arcTo(n,o,n-a,o,a),this.lineTo(s,o),this.lineTo(s,i),this.lineTo(t,i),this.lineTo(t,e+a),this.arcTo(t,e,t+a,e,a),this.closePath()},window.rectanglesCollide=function(t,e,n,o,i,r,s,l){return!(i>=n||s<=t||r>=o||l<=e)},window.svgBlobForHTML=function(t,e){var n,o,i;return null==e&&(e="font-size:12px"),(o=document.createElement("span")).setAttribute("style",e),o.innerHTML=t,document.body.appendChild(o),o=$(o),i=o.width()+2,n=o.height()+2,o.remove(),window.makeBlob("<svg xmlns='http://www.w3.org/2000/svg' width='"+i+"' height='"+n+"'><foreignObject width='100%' height='100%'><div xmlns='http://www.w3.org/1999/xhtml' style='"+e+"'>"+t+"</div></foreignObject></svg>","image/svg+xml;charset=utf-8")},window.makeBlob=function(t,e){var n,o,i,r,s;try{return new Blob([t],{type:e})}catch(l){if(o=l,window.BlobBuilder=null!=(i=null!=(r=null!=(s=window.BlobBuilder)?s:window.WebKitBlobBuilder)?r:window.MozBlobBuilder)?i:window.MSBlobBuilder,"TypeError"===o.name&&null!=window.BlobBuilder)return(n=new BlobBuilder).append(t.buffer),n.getBlob(e);if("InvalidStateError"===o.name)return new Blob([t.buffer],{type:e})}},drawHTMLCache={order:[],maxSize:100},cacheLookup=function(t,e){var n;return n=JSON.stringify([t,e]),drawHTMLCache.hasOwnProperty(n)?drawHTMLCache[n]:null},addToCache=function(t,e,n){var o;return o=JSON.stringify([t,e]),drawHTMLCache[o]=n,markUsed(t,e)},markUsed=function(t,e){var n,o;return o=JSON.stringify([t,e]),(n=drawHTMLCache.order.indexOf(o))>-1&&drawHTMLCache.order.splice(n,1),drawHTMLCache.order.unshift(o),pruneCache()},pruneCache=function(){var t;for(t=[];drawHTMLCache.order.length>drawHTMLCache.maxSize;)t.push(delete drawHTMLCache[drawHTMLCache.order.pop()]);return t},CanvasRenderingContext2D.prototype.drawHTML=function(t,e,n,o){var i,r;return null==o&&(o="font-size:12px"),(i=cacheLookup(t,o))?(this.drawImage(i,e,n),markUsed(t,o),!0):(r=objectURLForBlob(svgBlobForHTML(t,o)),i=new Image,i.onload=function(){var e,n;return addToCache(t,o,i),(null!=(e=null!=(n=window.URL)?n:window.webkitURL)?e:window).revokeObjectURL(r)},i.onerror=function(e){return addToCache(t,o,new Image),console.log("Failed to load SVG with this <foreignObject> div content:",t)},i.src=r,!1)},CanvasRenderingContext2D.prototype.measureHTML=function(t,e){var n;return null==e&&(e="font-size:12px"),(n=cacheLookup(t,e))?(markUsed(t,e),{width:n.width,height:n.height}):(this.drawHTML(t,0,0,e),null)},window.objectURLForBlob=function(t){var e,n;return(null!=(e=null!=(n=window.URL)?n:window.webkitURL)?e:window).createObjectURL(t)},window.base64URLForBlob=function(t,e){var n;return n=new FileReader,n.onload=function(t){return e(t.target.result)},n.readAsDataURL(t)},window.blobForBase64URL=function(t){var e,n,o,i,r,s,l;for(n=atob(t.split(",")[1]),s=t.split(",")[0].split(":")[1].split(";")[0],e=new ArrayBuffer(n.length),i=new Uint8Array(e),o=r=0,l=n.length;0<=l?r<l:r>l;o=0<=l?++r:--r)i[o]=n.charCodeAt(o);return window.makeBlob(e,s)},Dependencies=function(){function t(t){this.editor=t,this.length=0}return t.prototype.getFileMetadata=function(t,e,n,o){var i;if(null!==e)return null===t&&(t="."),i=t.concat([e]),this.editor.Storage.directRead("browser storage",i,n,o)},t.prototype.import=function(t){var e,n,o,i,r;for(e=n=0,i=this.length;0<=i?n<i:n>i;e=0<=i?++n:--n)delete this[e];for(e=o=0,r=this.length=t.length;0<=r?o<r:o>r;e=0<=r?++o:--o)this[e]=JSON.parse(JSON.stringify(t[e]));return this.update()},t.prototype.export=function(){var t,e,n,o;for(o=[],t=e=0,n=this.length;0<=n?e<n:e>n;t=0<=n?++e:--e)o.push(JSON.parse(JSON.stringify(this[t])));return o},t.prototype.update=function(t){var e,n,o,i,r,s;if(null==t)return function(){var t,e,n;for(n=[],i=t=0,e=this.length;0<=e?t<e:t>e;i=0<=e?++t:--t)n.push(this.update(i));return n}.call(this);if(t>=0&&t<this.length)return"file://"===(e=this[t]).address.slice(0,7)?(s=e.address.lastIndexOf("/"),n=e.address.slice(s),o=e.address.slice(7,s),this.getFileMetadata(o,n,function(e){return function(n){var o,i;if(o=n.exports,i=e[t],JSON.stringify(o)!==JSON.stringify(i))return e[t].data=o,e[t].date=new Date,e.editor.fire("dependenciesChanged")}}(this),function(t){})):"wiki://"===e.address.slice(0,7)?(r=e.address.slice(7),this.editor.MediaWiki.getPageTimestamp(r,function(n){return function(o,i){var s,l;if(null!=o&&(l=new Date(o),s=new Date(e.date),l>s))return n.editor.MediaWiki.getPageMetadata(r,function(e){if(null!=e&&JSON.stringify(n[t])!==JSON.stringify(e.exports))return n[t].data=e.exports,n[t].date=l,n.editor.fire("dependenciesChanged")})}}(this))):this.editor.fire("dependenciesChanged")},t.prototype.add=function(t,e){var n,o,i,r,s;if("file://"===t.slice(0,7)){s=t.lastIndexOf("/"),o=t.slice(s),i=t.slice(7,s);try{return this.getFileMetadata(i,o,function(n){return function(o){var i;return i=o.exports,n[n.length++]={address:t,data:i,date:new Date},"function"==typeof e&&e(i,null),n.editor.fire("dependenciesChanged")}}(this),function(t){return"function"==typeof e?e(null,t):void 0})}catch(t){return n=t,"function"==typeof e?e(null,n):void 0}}else if("wiki://"===t.slice(0,7))return r=t.slice(7),this.editor.MediaWiki.getPageTimestamp(r,function(n){return function(o,i){return null==o?"function"==typeof e?e(null,"Could not get wiki page timestamp"):void 0:n.editor.MediaWiki.getPageMetadata(r,function(i){return null==i?"function"==typeof e?e(null,"Could not access wiki page"):void 0:(n[n.length++]={address:t,data:i.exports,date:new Date(o)},"function"==typeof e&&e(i.exports,null),n.editor.fire("dependenciesChanged"))})}}(this))},t.prototype.remove=function(t){var e,n,o,i;if(t>=0&&t<this.length){for(e=n=o=t,i=this.length-1;o<=i?n<i:n>i;e=o<=i?++n:--n)this[e]=this[e+1];return delete this[--this.length],this.editor.fire("dependenciesChanged")}},t.prototype.installUI=function(t){var e,n,o,i,r,s,l,a,u,c;for(a=[],o=i=0,s=(u=this).length;i<s;o=++i)e=u[o],a.push(this.editor.Settings.UI.generalPair(e.address,this.editor.Settings.UI.button("Remove","dependencyRemove"+o),"dependencyRow"+o,80,"center"));for(0===this.length&&a.push(this.editor.Settings.UI.info("(no dependencies)")),a.push(this.editor.Settings.UI.info(this.editor.Settings.UI.button("Add file dependency","dependencyAddFile")+" "+this.editor.Settings.UI.button("Add wiki page dependency","dependencyAddWiki"))),t.innerHTML=a.join("\n"),n=function(e){return t.ownerDocument.getElementById(e)},o=r=0,l=(c=this).length;r<l;o=++r)e=c[o],n("dependencyRemove"+o).addEventListener("click",function(e){return function(n){return function(){return e.remove(n),e.installUI(t)}}}(this)(o));return n("dependencyAddFile").addEventListener("click",function(e){return function(){return e.editor.Storage.tryToOpen(function(n,o){if(null!=o)return null!=n?n+="/":n="",e.add("file://"+n+o,function(n,o){return null!=o?e.editor.Dialogs.alert({title:"Error adding dependency",message:o}):e.installUI(t)})})}}(this)),n("dependencyAddWiki").addEventListener("click",function(e){return function(){var n;if(n=prompt("Enter the wiki page name of the dependency to add.","Example Page Name"))return e.add("wiki://"+n,function(n,o){return null!=o?e.editor.Dialogs.alert({title:"Error adding dependency",message:o}):e.installUI(t)})}}(this))},t}(),tinymce.PluginManager.add("dependencies",function(t,e){return t.Dependencies=new Dependencies(t)}),prepareHTML=function(t){var e;return e=function(){var t,e,n,o,i,r;for((e=function(t,e){var n,o,i,r,s;for(s=[],o=0,i=(r=document.getElementsByTagName(t)).length;o<i;o++)n=r[o],s.push(n.addEventListener(e,function(t){return parent.postMessage({value:t.currentTarget.value,id:t.currentTarget.getAttribute("id")},"*")}));return s})("a","click"),e("input","click"),e("input","input"),n=0,o=(i=document.getElementsByTagName("input")).length;n<o;n++)"file"===(t=i[n]).getAttribute("type")&&t.addEventListener("change",function(){var t;return t=new FileReader,t.onload=function(t){return function(e){return parent.postMessage({value:e.target.result,id:t.getAttribute("id")},"*")}}(this),t.readAsDataURL(this.files[0])});return null!=(r=document.getElementsByTagName("input")[0])?r.focus():void 0},window.objectURLForBlob(window.makeBlob(t+"<script>("+e+")()<\/script>","text/html;charset=utf-8"))},installClickListener=function(t){var e;return e=function(e){return t(e.data)},window.addEventListener("message",e,!1),tinymce.activeEditor.windowManager.getWindows()[0].on("close",function(){return window.removeEventListener("message",e)})},(Dialogs={}).alert=function(t){var e,n,o,i;if(e=tinymce.activeEditor.windowManager.open({title:null!=(n=t.title)?n:" ",url:prepareHTML(t.message),width:null!=(o=t.width)?o:400,height:null!=(i=t.height)?i:300,buttons:[{type:"button",text:"OK",subtype:"primary",onclick:function(n){return e.close(),"function"==typeof t.callback?t.callback(n):void 0}}]}),t.onclick)return installClickListener(t.onclick)},Dialogs.confirm=function(t){var e,n,o,i,r,s;if(e=tinymce.activeEditor.windowManager.open({title:null!=(n=t.title)?n:" ",url:prepareHTML(t.message),width:null!=(o=t.width)?o:400,height:null!=(i=t.height)?i:300,buttons:[{type:"button",text:null!=(r=t.Cancel)?r:"Cancel",subtype:"primary",onclick:function(n){return e.close(),"function"==typeof t.cancelCallback?t.cancelCallback(n):void 0}},{type:"button",text:null!=(s=t.OK)?s:"OK",subtype:"primary",onclick:function(n){return e.close(),"function"==typeof t.okCallback?t.okCallback(n):void 0}}]}),t.onclick)return installClickListener(t.onclick)},Dialogs.prompt=function(t){var e,n,o,i,r,s,l,a,u;return u=t.value?" value='"+t.value+"'":"",t.message+="<p><input type='text' "+u+" id='promptInput' size=40/></p>",n=null!=(o=t.value)?o:"",e=tinymce.activeEditor.windowManager.open({title:null!=(i=t.title)?i:" ",url:prepareHTML(t.message),width:null!=(r=t.width)?r:300,height:null!=(s=t.height)?s:200,buttons:[{type:"button",text:null!=(l=t.Cancel)?l:"Cancel",subtype:"primary",onclick:function(o){return e.close(),"function"==typeof t.cancelCallback?t.cancelCallback(n):void 0}},{type:"button",text:null!=(a=t.OK)?a:"OK",subtype:"primary",onclick:function(o){return e.close(),"function"==typeof t.okCallback?t.okCallback(n):void 0}}]}),installClickListener(function(t){if("promptInput"===t.id)return n=t.value})},Dialogs.promptForFile=function(t){var e,n,o,i,r,s,l,a;return a=t.value?" value='"+t.value+"'":"",t.types?" accept='"+t.types+"'":"",t.message+="<p><input type='file' "+a+" id='promptInput'/></p>",n=null,e=tinymce.activeEditor.windowManager.open({title:null!=(o=t.title)?o:" ",url:prepareHTML(t.message),width:null!=(i=t.width)?i:400,height:null!=(r=t.height)?r:100,buttons:[{type:"button",text:null!=(s=t.Cancel)?s:"Cancel",subtype:"primary",onclick:function(n){return e.close(),"function"==typeof t.cancelCallback?t.cancelCallback():void 0}},{type:"button",text:null!=(l=t.OK)?l:"OK",subtype:"primary",onclick:function(o){return e.close(),"function"==typeof t.okCallback?t.okCallback(n):void 0}}]}),installClickListener(function(t){if("promptInput"===t.id)return n=t.value})},Dialogs.codeEditor=function(t){var e,n,o,i,r,s,l,a,u,c,d,p;return d=function(t){var e;return window.codeEditor=CodeMirror.fromTextArea(document.getElementById("editor"),{lineNumbers:!0,fullScreen:!0,autofocus:!0,theme:"base16-light",mode:t}),e=function(t){if("getEditorContents"===t.data)return parent.postMessage(window.codeEditor.getValue(),"*")},window.addEventListener("message",e,!1)},o="<html><head> <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.min.css'> <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/theme/base16-light.min.css'> <script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.min.js'><\/script> <script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/addon/display/fullscreen.min.js'><\/script> <script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/mode/javascript/javascript.min.js'><\/script> </head> <body style='margin: 0px;'> <textarea id='editor'>"+(null!=(i=t.value)?i:"")+"</textarea> <script> ("+d+')("'+(null!=(r=t.language)?r:"javascript")+'") <\/script> </body></html>',p=null,e=tinymce.activeEditor.windowManager.open({title:null!=(s=t.title)?s:"Code editor",url:window.objectURLForBlob(window.makeBlob(o,"text/html;charset=utf-8")),width:null!=(l=t.width)?l:700,height:null!=(a=t.height)?a:500,buttons:[{type:"button",text:null!=(u=t.Cancel)?u:"Discard",subtype:"primary",onclick:function(n){return p=t.cancelCallback,e.getContentWindow().postMessage("getEditorContents","*")}},{type:"button",text:null!=(c=t.OK)?c:"Save",subtype:"primary",onclick:function(n){return p=t.okCallback,e.getContentWindow().postMessage("getEditorContents","*")}}]}),n=function(t){return e.close(),"function"==typeof p?p(t.data):void 0},window.addEventListener("message",n,!1),e.on("close",function(){return window.removeEventListener("message",n)})},Dialogs.waiting=function(t){var e,n,o,i;return e=tinymce.activeEditor.windowManager.open({title:null!=(n=t.title)?n:" ",url:prepareHTML(t.message),width:null!=(o=t.width)?o:300,height:null!=(i=t.height)?i:100,buttons:[]}),t.onclick&&installClickListener(t.onclick),t.work(function(){return e.close()})},tinymce.PluginManager.add("dialogs",function(t,e){return t.Dialogs=Dialogs}),DownloadUpload=function(){function t(t){var e;this.editor=t,(e=function(t){return function(e,n){var o,i;return o={icon:n.icon,shortcut:n.shortcut,onclick:n.onclick,tooltip:n.tooltip},i=null!=n.icon?"icon":"text",o[i]=n[i],t.editor.addButton(e,o),t.editor.addMenuItem(e,n)}}(this))("download",{text:"Download",icon:"arrowdown2",context:"file",tooltip:"Download this document",onclick:function(t){return function(){return t.downloadDocument()}}(this)}),e("upload",{text:"Upload",icon:"arrowup2",context:"file",tooltip:"Upload new document",onclick:function(t){return function(){return t.uploadDocument()}}(this)})}return t.prototype.downloadDocument=function(){var t,e,n;return e=this.editor.Storage.embedMetadata(this.editor.getContent(),this.editor.Settings.document.metadata),t=new Blob([e],{type:"text/html"}),(n=document.createElement("a")).setAttribute("href",URL.createObjectURL(t)),n.setAttribute("download",editor.Storage.filename||"untitled.html"),n.click(),URL.revokeObjectURL(n.getAttribute("href"))},t.prototype.uploadDocument=function(){return editor.Storage.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return editor.Storage.tryToSave(function(e){if(e)return t.letUserUpload()}),t.editor.windowManager.close()}}(this)},{text:"Discard",onclick:function(t){return function(){return t.editor.windowManager.close(),t.letUserUpload()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):this.letUserUpload()},t.prototype.letUserUpload=function(){return this.editor.Dialogs.promptForFile({title:"Choose file",message:"Choose an HTML file to upload into the editor.",okCallback:function(t){return function(e){var n,o,i,r;return o=atob(e.split(",")[1]),r=t.editor.Storage.extractMetadata(o),i=r.metadata,n=r.document,t.editor.setContent(n),null!=i&&(t.editor.Settings.document.metadata=i),t.editor.focus()}}(this)})},t}(),tinymce.PluginManager.add("downloadupload",function(t,e){return t.DownloadUpload=new DownloadUpload(t)}),grouperHTML=function(t,e,n,o,i){return null==o&&(o=!0),o=o?" hide":"",null==i&&(i="images/red-bracket-"+e+".png"),"<img src='"+i+"' class='grouper "+t+o+"' id='"+e+n+"'>"},window.grouperHTML=grouperHTML,grouperInfo=function(t){var e,n,o;return(e=/^(open|close)([0-9]+)$/.exec(null!=t&&"function"==typeof t.getAttribute?t.getAttribute("id"):void 0))?(o={openOrClose:e[1],id:parseInt(e[2])},(n=/^grouper ([^ ]+)/.exec(null!=t&&"function"==typeof t.getAttribute?t.getAttribute("class"):void 0))&&(o.type=n[1]),o):null},window.grouperInfo=grouperInfo,createStyleString=function(t){var e,n,o,i,r,s,l;null==t&&(t=window.defaultEditorStyles),s=[];for(n in t)if(hasProp.call(t,n)){for(l=t[n],r="",e=0,o=n.length;e<o;e++)(i=n[e]).toUpperCase()===i&&(r+="-"),r+=i.toLowerCase();s.push(r+":"+l+";")}return s.join(" ")},htmlToImage=function(t){return objectURLForBlob(svgBlobForHTML(t,createStyleString()))},createFontStyleString=function(t){var e;return"font-size:"+(e=t.ownerDocument.defaultView.getComputedStyle(t)).fontSize+"; font-family:"+e.fontFamily+";"},Group=function(){function t(t,e,n){var o,i,r,s;if(this.open=t,this.close=e,this.plugin=n,this.getScreenBoundaries=bind(this.getScreenBoundaries,this),this.connectionsIn=bind(this.connectionsIn,this),this.connectionsOut=bind(this.connectionsOut,this),this.disconnect=bind(this.disconnect,this),this.connect=bind(this.connect,this),this.toJSON=bind(this.toJSON,this),this.contentsChanged=bind(this.contentsChanged,this),this.nextSibling=bind(this.nextSibling,this),this.previousSibling=bind(this.previousSibling,this),this.indexInParent=bind(this.indexInParent,this),this.groupAsHTML=bind(this.groupAsHTML,this),this.stillInEditor=bind(this.stillInEditor,this),this.remove=bind(this.remove,this),this.rangeAfter=bind(this.rangeAfter,this),this.rangeBefore=bind(this.rangeBefore,this),this.outerRange=bind(this.outerRange,this),this.innerRange=bind(this.innerRange,this),this.setContentAsText=bind(this.setContentAsText,this),this.contentNodes=bind(this.contentNodes,this),this.contentAsHTML=bind(this.contentAsHTML,this),this.contentAsFragment=bind(this.contentAsFragment,this),this.contentAsText=bind(this.contentAsText,this),this.updateGrouper=bind(this.updateGrouper,this),this.clear=bind(this.clear,this),this.keys=bind(this.keys,this),this.get=bind(this.get,this),this.set=bind(this.set,this),this.type=bind(this.type,this),this.typeName=bind(this.typeName,this),this.id=bind(this.id,this),null==this.plugin)for(i=0,r=(s=tinymce.editors).length;i<r;i++)if((o=s[i]).getDoc()===this.open.ownerDocument){this.plugin=o.Groups;break}this.contentsChanged(!0,!0)}return t.prototype.id=function(){var t,e;return null!=(t=null!=(e=grouperInfo(this.open))?e.id:void 0)?t:null},t.prototype.typeName=function(){var t;return null!=(t=grouperInfo(this.open))?t.type:void 0},t.prototype.type=function(){var t,e;return null!=(t=this.plugin)&&null!=(e=t.groupTypes)?e[this.typeName()]:void 0},t.prototype.set=function(t,e){var n,o,i,r,s,l,a;if(/^[a-zA-Z0-9-_]+$/.test(t)&&(a=JSON.stringify([e]),this.open.getAttribute("data-"+t)!==a&&(this.open.setAttribute("data-"+t,a),null!=this.plugin&&(this.plugin.editor.fire("change"),this.plugin.editor.isNotDirty=!1,this.contentsChanged()),"openDecoration"!==t&&"closeDecoration"!==t||this.updateGrouper(t.slice(0,-10)),"openHoverText"===t||"closeHoverText"===t))){for(o=this[t.slice(0,-9)],l=[],i=0,r=(s=["title","alt"]).length;i<r;i++)n=s[i],l.push(o.setAttribute(n,""+e));return l}},t.prototype.get=function(t){try{return JSON.parse(this.open.getAttribute("data-"+t))[0]}catch(t){return void t}},t.prototype.keys=function(){return Object.keys(this.open.dataset)},t.prototype.clear=function(t){var e,n,o,i,r,s;if(/^[a-zA-Z0-9-_]+$/.test(t)&&null!=this.open.getAttribute("data-"+t)&&(this.open.removeAttribute("data-"+t),null!=this.plugin&&(this.plugin.editor.fire("change"),this.plugin.editor.isNotDirty=!1,this.contentsChanged()),"openDecoration"!==t&&"closeDecoration"!==t||this.updateGrouper(t.slice(0,-10)),"openHoverText"===t||"closeHoverText"===t)){for(n=this[t.slice(0,-9)],s=[],o=0,i=(r=["title","alt"]).length;o<i;o++)e=r[o],s.push(n.removeAttribute(e));return s}},t.prototype.updateGrouper=function(t){var e,n,o,i,r;if(t===this.open&&(t="open"),t===this.close&&(t="close"),"open"===t||"close"===t)return i=$(n=this[t]),null!=(e=this.get(t+"Decoration"))?i.addClass("decorate"):(i.removeClass("decorate"),e=""),o=i.hasClass("hide")?"":null!=(r=this.type())?r[t+"ImageHTML"]:void 0,"open"===t?o=e+o:o+=e,window.base64URLForBlob(window.svgBlobForHTML(o,createFontStyleString(n)),function(t){return function(e){var o,i;if(n.getAttribute("src")!==e)return n.setAttribute("src",e),null!=(o=t.plugin)&&null!=(i=o.editor.Overlay)?i.redrawContents():void 0}}(this))},t.prototype.contentAsText=function(){var t;return null!=(t=this.innerRange())?t.toString():void 0},t.prototype.contentAsFragment=function(){var t;return null!=(t=this.innerRange())?t.cloneContents():void 0},t.prototype.contentAsHTML=function(){var t,e;return(t=this.contentAsFragment())?((e=this.open.ownerDocument.createElement("div")).appendChild(t),e.innerHTML):null},t.prototype.contentNodes=function(){var t,e;for(t=[],e=this.open;null!=e;)if(strictNodeOrder(e,this.close))strictNodeOrder(this.open,e)&&t.push(e),e=null!=e.nextSibling?e.nextSibling:e.parentNode;else{if(strictNodeOrder(this.close,e)){console.log("Warning!! walked past @close...something is wrong with this loop");break}if(e===this.close)break;e=e.childNodes[0]}return t},t.prototype.setContentAsText=function(t){var e,n,o;if(e=this.innerRange())return null!=(n=this.plugin)&&n.editor.selection.setRng(e),null!=(o=this.plugin)?o.editor.selection.setContent(t):void 0},t.prototype.innerRange=function(){var t;t=this.open.ownerDocument.createRange();try{return t.setStartAfter(this.open),t.setEndBefore(this.close),t}catch(t){return t,null}},t.prototype.outerRange=function(){var t;t=this.open.ownerDocument.createRange();try{return t.setStartBefore(this.open),t.setEndAfter(this.close),t}catch(t){return t,null}},t.prototype.rangeBefore=function(){var t,e,n;n=(t=this.open.ownerDocument).createRange();try{return n.setEndBefore(this.open),(e=this.previousSibling())?n.setStartAfter(e.close):this.parent?n.setStartAfter(this.parent.open):n.setStartBefore(t.body.childNodes[0]),n}catch(t){return t,null}},t.prototype.rangeAfter=function(){var t,e,n;n=(t=this.open.ownerDocument).createRange();try{return n.setStartAfter(this.close),(e=this.nextSibling())?n.setEndBefore(e.open):this.parent?n.setEndBefore(this.parent.close):n.setEndAfter(t.body.childNodes[t.body.childNodes.length-1]),n}catch(t){return t,null}},t.prototype.remove=function(){var t,e,n,o,i,r,s;if(this.plugin){for(e=0,o=(r=this.connectionsIn()).length;e<o;e++)t=r[e],this.disconnect(this.plugin[t[0]]);for(n=0,i=(s=this.connectionsOut()).length;n<i;n++)t=s[n],this.disconnect(this.plugin[t[1]]);return this.plugin.editor.undoManager.transact(function(t){return function(){return $([t.open].concat(slice.call(t.contentNodes()),[t.close])).remove()}}(this))}},t.prototype.stillInEditor=function(){var t;for(t=this.open;null!=this.plugin&&null!=t;){if(t===this.plugin.editor.getDoc())return!0;t=t.parentNode}return!1},t.prototype.groupAsHTML=function(t){var e,n,o;return null==t&&(t=!0),(e=null!=(n=this.outerRange())?n.cloneContents():void 0)?((o=this.open.ownerDocument.createElement("div")).appendChild(e),t||$(o).find(".grouper").removeAttr("src"),o.innerHTML):null},t.prototype.indexInParent=function(){var t,e,n,o;return null!=(t=null!=(e=null!=(n=this.parent)?n.children:void 0)?e:null!=(o=this.plugin)?o.topLevel:void 0)?t.indexOf(this):void 0},t.prototype.previousSibling=function(){var t,e,n,o;return null!=(t=null!=(e=null!=(n=this.parent)?n.children:void 0)?e:null!=(o=this.plugin)?o.topLevel:void 0)?t[this.indexInParent()-1]:void 0},t.prototype.nextSibling=function(){var t,e,n,o;return null!=(t=null!=(e=null!=(n=this.parent)?n.children:void 0)?e:null!=(o=this.plugin)?o.topLevel:void 0)?t[this.indexInParent()+1]:void 0},t.prototype.contentsChanged=function(t,e){var n,o;if(null==t&&(t=!0),null==e&&(e=!1),null!=(n=this.type())&&"function"==typeof n.contentsChanged&&n.contentsChanged(this,e),t)return null!=(o=this.parent)?o.contentsChanged(!0):void 0},t.prototype.toJSON=function(){var t,e,n,o,i,r,s,l;for(n={},o=0,i=(r=this.open.attributes).length;o<i;o++)if("data-"===(t=r[o]).nodeName.slice(0,6)&&"data-mce-"!==t.nodeName.slice(0,10))try{n[t.nodeName]=JSON.parse(t.nodeValue)[0]}catch(t){}return{id:this.id(),typeName:this.typeName(),deleted:this.deleted,text:this.contentAsText(),html:this.contentAsHTML(),parent:null!=(s=null!=(l=this.parent)?l.id():void 0)?s:null,children:function(){var t,n,o,i,r,s;for(s=[],t=0,n=(i=null!=(o=this.children)?o:[]).length;t<n;t++)e=i[t],s.push(null!=(r=null!=e?e.id():void 0)?r:null);return s}.call(this),data:n}},t.prototype.connect=function(t,e){var n,o,i,r,s,l,a,u,c,d;for(null==e&&(e=""),o=""+(n=[this.id(),t.id(),""+e]),a=!0,i=0,s=(u=null!=(c=this.get("connections"))?c:[]).length;i<s;i++)if(""+u[i]===o){a=!1;break}for(a&&this.set("connections",slice.call(u).concat([n])),a=!0,r=0,l=(u=null!=(d=t.get("connections"))?d:[]).length;r<l;r++)if(""+u[r]===o){a=!1;break}if(a)return t.set("connections",slice.call(u).concat([n]))},t.prototype.disconnect=function(t,e){var n,o;return null==e&&(e=""),o=function(n){return function(o){return o[0]===n.id()&&o[1]===t.id()&&(e===o[2]||("function"==typeof e.test?e.test(o[2]):void 0))}}(this),this.set("connections",function(){var t,e,i,r,s;for(s=[],t=0,e=(r=null!=(i=this.get("connections"))?i:[]).length;t<e;t++)n=r[t],o(n)||s.push(n);return s}.call(this)),t.set("connections",function(){var e,i,r,s,l;for(l=[],e=0,i=(s=null!=(r=t.get("connections"))?r:[]).length;e<i;e++)n=s[e],o(n)||l.push(n);return l}())},t.prototype.connectionsOut=function(){var t,e,n,o,i,r,s;for(e=this.id(),s=[],n=0,o=(r=null!=(i=this.get("connections"))?i:[]).length;n<o;n++)(t=r[n])[0]===e&&s.push(t);return s},t.prototype.connectionsIn=function(){var t,e,n,o,i,r,s;for(e=this.id(),s=[],n=0,o=(r=null!=(i=this.get("connections"))?i:[]).length;n<o;n++)(t=r[n])[1]===e&&s.push(t);return s},t.prototype.getScreenBoundaries=function(){var t,e,n,o,i,r,s,l,a,u;if(u=function(t){var e,n,o,i;if(null!=t){for(i=[],e=n=0,o=t.length;0<=o?n<o:n>o;e=0<=o?++n:--n)i.push(t[e]);return i}return[]},0===(l=u(this.open.getClientRects()).concat(u(null!=(a=this.outerRange())?a.getClientRects():void 0)).concat(u(this.close.getClientRects()))).length)return null;for(r={top:(r=l[0]).top,left:r.left,right:r.right,bottom:r.bottom},t={top:(t=l[l.length-1]).top,left:t.left,right:t.right,bottom:t.bottom},i=!0,e=n=0,o=l.length;n<o;e=++n)s=l[e],r.top=Math.min(r.top,s.top),t.bottom=Math.max(t.bottom,s.bottom),s.left<r.left&&(i=!1),s.top>r.bottom&&(i=!1);return i&&(t.top=r.top,r.bottom=t.bottom),r.top!==r.bottom&&t.top!==t.bottom&&r.left!==r.right&&t.left!==t.right||$(this.open).hasClass("hide")?{open:r,close:t}:null},t}(),window.Group=Group,Groups=function(){function t(t){this.editor=t,this.drawGroups=bind(this.drawGroups,this),this.grouperIndexOfRangeEndpoint=bind(this.grouperIndexOfRangeEndpoint,this),this.groupsTouchingRange=bind(this.groupsTouchingRange,this),this.rangeChanged=bind(this.rangeChanged,this),this.groupAboveSelection=bind(this.groupAboveSelection,this),this.groupAboveCursor=bind(this.groupAboveCursor,this),this.groupAboveNode=bind(this.groupAboveNode,this),this.grouperToGroup=bind(this.grouperToGroup,this),this.ids=bind(this.ids,this),this.registerGroup=bind(this.registerGroup,this),this.scanDocument=bind(this.scanDocument,this),this.enableScanning=bind(this.enableScanning,this),this.disableScanning=bind(this.disableScanning,this),this.hideOrShowGroupers=bind(this.hideOrShowGroupers,this),this.allGroupers=bind(this.allGroupers,this),this.groupCurrentSelection=bind(this.groupCurrentSelection,this),this.updateConnectionsMode=bind(this.updateConnectionsMode,this),this.updateButtonsAndMenuItems=bind(this.updateButtonsAndMenuItems,this),this.addGroupType=bind(this.addGroupType,this),this.setUsedID=bind(this.setUsedID,this),this.isIdFree=bind(this.isIdFree,this),this.addFreeId=bind(this.addFreeId,this),this.nextFreeId=bind(this.nextFreeId,this),this.groupTypes={},this.topLevel=[],this.freeIds=[0],this.editor.Overlay.addDrawHandler(this.drawGroups)}var e;return t.prototype.nextFreeId=function(){return this.freeIds.length>1?this.freeIds.shift():this.freeIds[0]++},t.prototype.addFreeId=function(t){if(t<this.freeIds[this.freeIds.length-1])return this.freeIds.push(t),this.freeIds.sort(function(t,e){return t-e})},t.prototype.isIdFree=function(t){return indexOf.call(this.freeIds,t)>=0||t>this.freeIds[this.freeIds.length]},t.prototype.setUsedID=function(t){var e,n;for(n=this.freeIds[this.freeIds.length-1];n<t;)this.freeIds.push(++n);if(e=this.freeIds.indexOf(t),this.freeIds.splice(e,1),e===this.freeIds.length)return this.freeIds.push(t+1)},t.prototype.addGroupType=function(t,e){var n,o,i,r,s,l,a;return null==e&&(e={}),t=function(){var e,n,o;for(o=[],e=0,n=t.length;e<n;e++)s=t[e],/[a-zA-Z_-]/.test(s)&&o.push(s);return o}().join(""),this.groupTypes[t]=e,e.hasOwnProperty("text")&&(l=this,null!=e.imageHTML&&(e.image=htmlToImage(e.imageHTML)),null!=e.openImageHTML&&(n=svgBlobForHTML(e.openImageHTML,createStyleString()),e.openImage=objectURLForBlob(n),base64URLForBlob(n,function(t){return e.openImage=t})),null!=e.closeImageHTML&&(n=svgBlobForHTML(e.closeImageHTML,createStyleString()),e.closeImage=objectURLForBlob(n),base64URLForBlob(n,function(t){return e.closeImage=t})),r={text:e.text,context:null!=(a=e.context)?a:"Insert",onclick:function(e){return function(){return e.groupCurrentSelection(t)}}(this),onPostRender:function(){return l.groupTypes[t].menuItem=this,l.updateButtonsAndMenuItems()}},null!=e.shortcut&&(r.shortcut=e.shortcut),null!=e.icon&&(r.icon=e.icon),this.editor.addMenuItem(t,r),(o={tooltip:e.tooltip,onclick:function(e){return function(){return e.groupCurrentSelection(t)}}(this),onPostRender:function(){return l.groupTypes[t].button=this,l.updateButtonsAndMenuItems()}})[i=null!=e.image?"image":null!=e.icon?"icon":"text"]=e[i],this.editor.addButton(t,o)),null!=e.connections?e.connections:e.connections=function(t){var e,n;return n=t.connectionsOut(),slice.call(n).concat(slice.call(function(){var t,o,i;for(i=[],t=0,o=n.length;t<o;t++)e=n[t],i.push(e[1]);return i}()))}},t.prototype.updateButtonsAndMenuItems=function(){var t,e,n,o,i,r,s,l,a,u,c;if(t=null!=(n=this.editor)&&null!=(o=n.selection)&&null!=(i=o.getRng())?i.cloneRange():void 0){u=t.cloneRange(),t.collapse(!0),u.collapse(!1),t=this.groupAboveCursor(t),u=this.groupAboveCursor(u),r=this.groupTypes;for(e in r)hasProp.call(r,e)&&(null!=(c=r[e])&&null!=(s=c.button)&&s.disabled(t!==u),null!=c&&null!=(l=c.menuItem)&&l.disabled(t!==u));return null!=(a=this.connectionsButton)&&a.disabled(null==t||t!==u),this.updateConnectionsMode()}},t.prototype.updateConnectionsMode=function(){var t,e;if(null!=(t=this.connectionsButton)?t.disabled():void 0)return null!=(e=this.connectionsButton)?e.active(!1):void 0},t.prototype.groupCurrentSelection=function(t){var e,n,o,i,r,s,l,a,u,c,d,p,h,f,g,m;if(this.groupTypes.hasOwnProperty(t))return i=$(null!=(d=this.allGroupers())?d[0]:void 0).hasClass("hide"),r=this.nextFreeId(),u=grouperHTML(t,"open",r,i,this.groupTypes[t].openImage),e=grouperHTML(t,"close",r,i,this.groupTypes[t].closeImage),(m=this.editor.selection).getStart()===m.getEnd()?(n=this.editor.selection.getContent(),this.editor.insertContent(u+n+"{$caret}"+e),"P"===(e=null!=(p=(o=this.editor.selection.getRng()).endContainer.childNodes[o.endOffset])?p:o.endContainer.nextSibling).tagName&&(e=e.childNodes[0]),null!=(h=(a=this.grouperToGroup(e)).parent)&&h.contentsChanged()):(s=(c=m.getRng()).startContainer,l=c.startOffset,c.endContainer,c.endOffset,c.collapse(!1),m.setRng(c),this.disableScanning(),this.editor.insertContent("{$caret}"+e),e=null!=(f=(c=m.getRng()).endContainer.childNodes[c.endOffset])?f:c.endContainer.nextSibling,c.setStart(s,l),c.setEnd(s,l),m.setRng(c),this.editor.insertContent(u),this.enableScanning(),this.editor.selection.select(e),this.editor.selection.collapse(!0),null!=(g=(a=this.grouperToGroup(e)).parent)&&g.contentsChanged()),a},t.prototype.allGroupers=function(){return this.editor.getDoc().getElementsByClassName("grouper")},t.prototype.hideOrShowGroupers=function(){var t,e;return t=$(this.allGroupers()),$(null!=t?t[0]:void 0).hasClass("hide")?t.removeClass("hide"):t.addClass("hide"),t.filter(".decorate").each(function(t){return function(e,n){return t.grouperToGroup(n).updateGrouper(n)}}(this)),null!=(e=this.editor.Overlay)&&e.redrawContents(),this.editor.focus()},t.prototype.disableScanning=function(){return this.scanLocks=(null!=this.scanLocks?this.scanLocks:this.scanLocks=0)+1},t.prototype.enableScanning=function(){var t;if(this.scanLocks=Math.max((null!=(t=this.scanLocks)?t:0)-1,0),0===this.scanLocks)return this.scanDocument()},e=!1,t.prototype.scanDocument=function(){var t,n,o,i,r,s,l,a,u,c,d,p,h,f,g,m,y,v,b,w,C,x,k,T,I,S,M,O,N,L,A,D,R,B,E,P,U,F,G;if(!(this.scanLocks>0)){if(e)return setTimeout(function(t){return function(){return t.scanDocument}}(this),0);for(e=!0,g=0,y=(L=this.ids()).length;g<y;g++)null!=this[p=L[g]]&&(this[p].old=!0);for(d=Array.prototype.slice.apply(this.allGroupers()),l=[],G=[],this.topLevel=[],this.idConversionMap={},i=this.freeIds.slice(0),h=function(t){var e,n,o;for(e=n=0,o=l.length;n<o;e=++n)if(l[e].id===t)return e;return-1},m=0,v=d.length;m<v;m++)if(c=d[m],null==(f=grouperInfo(c)))$(c).remove();else if("open"===f.openOrClose)l.unshift({id:f.id,grouper:c,children:[]});else if(-1===h(f.id))$(c).remove();else{for(;l[0].id!==f.id;)$(l.shift().grouper).remove();for(u=l.shift(),p=this.registerGroup(u.grouper,c),G.push(p),(I=this[p]).children=u.children,T=0,b=(A=I.children).length;T<b;T++)A[T].parent=I;l.length>0?l[0].children.push(I):(this.topLevel.push(I),I.parent=null)}for(;l.length>0;)$(l.shift().grouper).remove();for(G.sort(function(t,e){return t-e}),r=0,this.freeIds=[];G.length>0;){if(r===G[0])for(;r===G[0];)G.shift();else this.freeIds.push(r);r++}for(this.freeIds.push(r),n=this.freeIds.slice(0);i[i.length-1]<n[n.length-1];)i.push(i[i.length-1]+1);for(;n[n.length-1]<i[i.length-1];)n.push(n[n.length-1]+1);for(o=function(){var e,o,r;for(r=[],o=0,e=n.length;o<e;o++)t=n[o],indexOf.call(i,t)<0&&r.push(t);return r}(),s=[],S=0,w=o.length;S<w;S++)p=o[S],s.push(this[p]),null!=(D=this[p])&&(D.deleted=!0),delete this[p];for(O=0,C=s.length;O<C;O++)null!=(a=s[O])&&null!=(R=a.type())&&"function"==typeof R.deleted&&R.deleted(a);F=function(t){return function(e,n){var o,i,r,s;if(null==n&&(n="both"),i=e.get("connections")){for(p=e.id(),s=0,r=i.length;s<r;s++)o=i[s],("both"===n||o[0]===p&&"out"===n)&&t.idConversionMap.hasOwnProperty(o[1])&&(o[1]=t.idConversionMap[o[1]]),("both"===n||o[1]===p&&"in"===n)&&t.idConversionMap.hasOwnProperty(o[0])&&(o[0]=t.idConversionMap[o[0]]);return e.set("connections",i)}}}(this),B=this.idConversionMap;for(M in B)if(hasProp.call(B,M)){for(F(this[B[M]]),N=0,x=(E=I.connectionsOut()).length;N<x;N++)F(this[E[N][1]],"in");for(U=0,k=(P=I.connectionsIn()).length;U<k;U++)F(this[P[U][0]],"out")}return delete this.idsCache,setTimeout(function(t){return function(){var e;return null!=(e=t.editor.Overlay)&&e.redrawContents(),t.updateButtonsAndMenuItems()}}(this),0),e=!1}},t.prototype.registerGroup=function(t,e){var n,o,i,r;if((null!=(n=this[i=grouperInfo(t).id])?n.open:void 0)!==t||(null!=n?n.close:void 0)!==e){if(null!=this[i]&&!this[i].old){for(r=0,o=this.editor.getDoc();o.getElementById("open"+r||o.getElementById("close"+r));)r++;t.setAttribute("id","open"+r),e.setAttribute("id","close"+r),this.idConversionMap[i]=r,i=r}this[i]=new Group(t,e,this)}else delete this[i].old;return void 0!==t.naturalWidth&&0!==t.naturalWidth||this[i].updateGrouper("open"),void 0!==e.naturalWidth&&0!==e.naturalWidth||this[i].updateGrouper("close"),i},t.prototype.ids=function(){var t,e,n,o,i;if(null==this.idsCache)for(this.idsCache=[],o=function(t){return function(e){var n,i,r,s,l;for(t.idsCache.push(e.id()),l=[],i=0,r=(s=e.children).length;i<r;i++)n=s[i],l.push(o(n));return l}}(this),e=0,n=(i=this.topLevel).length;e<n;e++)t=i[e],o(t);return this.idsCache},t.prototype.grouperToGroup=function(t){var e,n;return null!=(e=null!=(n=grouperInfo(t))?n.id:void 0)?this[e]:null},t.prototype.groupAboveNode=function(t){var e,n,o,i,r;if(0===(e=this.allGroupers()).length)return null;if((o={index:0,grouper:e[0],leftOfNode:!0}).grouper===t)return this.grouperToGroup(o.grouper);if(!strictNodeOrder(o.grouper,t))return null;if((r={index:e.length-1,grouper:e[e.length-1]}).grouper===t)return this.grouperToGroup(r.grouper);if(strictNodeOrder(r.grouper,t))return null;for(;;){if(o.grouper===t)return this.grouperToGroup(o.grouper);if(r.grouper===t)return this.grouperToGroup(r.grouper);if(o.index+1===r.index)return(n=this.grouperToGroup(o.grouper))?o.grouper===n.open?n:n.parent:null;i=Math.floor((o.index+r.index)/2),strictNodeOrder(e[i],t)?o={index:i,grouper:e[i],leftOfNode:!0}:r={index:i,grouper:e[i],leftOfNode:!1}}},t.prototype.groupAboveCursor=function(t){var e,n,o,i;return 3===(null!=(i=t.startContainer)?i.nodeType:void 0)?this.groupAboveNode(t.startContainer):t.startContainer.childNodes.length>t.startOffset?(e=t.startContainer.childNodes[t.startOffset],(null!=(o=this.groupAboveNode(e))?o.open:void 0)===e?o.parent:o):t.startContainer.childNodes.length>0?(n=t.startContainer.childNodes[t.startOffset-1],(null!=(o=this.groupAboveNode(n))?o.close:void 0)===n?o.parent:o):this.groupAboveNode(t.startContainer)},t.prototype.groupAboveSelection=function(t){var e,n,o,i,r;for((e=t.cloneRange()).collapse(!0),e=this.groupAboveCursor(e),n=[];null!=e;)n.unshift(e),e=e.parent;for((i=t.cloneRange()).collapse(!1),i=this.groupAboveCursor(i),r=[];null!=i;)r.unshift(i),i=i.parent;for(o=null;n.length>0&&r.length>0&&n[0]===r[0];)o=n.shift(),r.shift();return o},t.prototype.rangeChanged=function(t){var e,n,o,i,r;for(r=[],n=0,o=(i=this.groupsTouchingRange(t)).length;n<o;n++)e=i[n],r.push(e.contentsChanged(!1));return r},t.prototype.groupsTouchingRange=function(t){var e,n,o,i,r,s,l,a,u,c,d,p,h;if(0===(e=this.allGroupers()).length)return[];if(n=1+this.grouperIndexOfRangeEndpoint(t,!0,e),s=this.grouperIndexOfRangeEndpoint(t,!1,e),n>s){for(1===(a=t.startContainer).nodeType&&t.startOffset<a.childNodes.length&&(a=a.childNodes[t.startOffset]),p=(o=this.groupAboveNode(a))?o.open===a?o.parent?[o.parent]:[]:[o]:[];l=null!=(u=p[p.length-1])?u.parent:void 0;)p.push(l);return p}for(h=[],p=[],i=r=c=n,d=s;c<=d?r<=d:r>=d;i=c<=d?++r:--r)o=this.grouperToGroup(e[i]),e[i]===o.open?h.push(o):(p.push(o),h.pop());for(;h.length>0;)p.push(h.pop());for(;l=p[p.length-1].parent;)p.push(l);return p},t.prototype.grouperIndexOfRangeEndpoint=function(t,e,n){var o,i,r,s;if(0===(null!=n?n:n=this.allGroupers()).length)return-1;if(o=e?Range.END_TO_START:Range.END_TO_END,i=function(e){return function(n){var i;return(i=e.editor.getDoc().createRange()).selectNode(n),t.compareBoundaryPoints(o,i)>-1}}(this),e=0,!i(n[e]))return-1;if(s=n.length-1,i(n[s]))return s;for(;;){if(e+1===s)return e;i(n[r=Math.floor((e+s)/2)])?e=r:s=r}},t.prototype.drawGroups=function(t,e){var n,o,i,r,s,l,a,u,c,d,p,h,f,g,m,y,v,b,w,C,x,k,T,I,S,M,O,N,L,A,D,R,B,E,P,U,F,G,H,j,W,J,_,z,q,$,K,Y,X,V,Z,Q,tt,et,nt;if(this.bubbleTags=[],!(this.scanLocks>0)){for(g=this.groupAboveSelection(this.editor.selection.getRng()),s=getComputedStyle(this.editor.getBody()),x=parseInt(s["margin-left"]),z=parseInt(s["margin-right"]),R=3,2,4,K=[],p=function(t){return function(n,o,i,r){var s,l,a,u,c,d,p,h,f,g,m;return p=n.type(),a=null!=(c=null!=p?p.color:void 0)?c:"#444444",(s=n.getScreenBoundaries())?(u=s.open,l=s.close,h=u.left-R/3,g=u.top-R,f=l.right+R/3,m=l.bottom+R,r&&(d=null!=p&&"function"==typeof p.tagContents?p.tagContents(n):void 0)&&K.push({content:d,corner:{x:h,y:g},color:a,style:createFontStyleString(n.open),group:n}),e.fillStyle=e.strokeStyle=a,u.top===l.top&&u.bottom===l.bottom?e.roundedRect(h,g,f,m,4):e.roundedZone(h,g,f,m,u.bottom,l.top,x,z,4),o&&(e.save(),e.globalAlpha=1,e.lineWidth=1.5,null!=p&&"function"==typeof p.setOutlineStyle&&p.setOutlineStyle(n,e),e.stroke(),e.restore()),i&&(e.save(),e.globalAlpha=.3,null!=p&&"function"==typeof p.setFillStyle&&p.setFillStyle(n,e),e.fill(),e.restore()),!0):(setTimeout(function(){var e;return null!=(e=t.editor.Overlay)?e.redrawContents():void 0},100),null)}}(this),v=!0,Z=g;Z;){if(!p(Z,!0,v,!0))return;Z=Z.parent,R+=2,v=!1}for(w=0,k=(P=null!=(E="function"==typeof this.visibleGroups?this.visibleGroups():void 0)?E:[]).length;w<k;w++)p(P[w],!0,!1,!0);for(Y=[];K.length>0;){if($=K.shift(),e.font=$.font,!(q=e.measureHTML($.content,$.style)))return void setTimeout(function(t){return function(){var e;return null!=(e=t.editor.Overlay)?e.redrawContents():void 0}}(this),10);for(Q=$.corner.x-2,et=$.corner.y-q.height-4,tt=Q+4+q.width,nt=$.corner.y,C=0,T=Y.length;C<T;C++)D=Y[C],rectanglesCollide(Q,et,tt,nt,D.x1,D.y1,D.x2,D.y2)&&(et+=N=D.y1-nt,nt+=N);U=[Q,et,tt,nt=$.corner.y],$.x1=U[0],$.y1=U[1],$.x2=U[2],$.y2=U[3],Y.unshift($)}for(O=0,I=Y.length;O<I;O++){if($=Y[O],e.roundedRect($.x1,$.y1,$.x2,$.y2,4),e.globalAlpha=1,e.save(),e.fillStyle="#ffffff",null!=(F=$.group)&&"function"==typeof F.type&&"function"==typeof(n=F.type()).setFillStyle&&n.setFillStyle($.group,e),e.fill(),e.restore(),e.save(),e.lineWidth=1.5,e.strokeStyle=$.color,null!=(G=$.group)&&"function"==typeof G.type&&"function"==typeof(o=G.type()).setOutlineStyle&&o.setOutlineStyle($.group,e),e.stroke(),e.restore(),e.save(),e.globalAlpha=.7,e.fillStyle=$.color,null!=(H=$.group)&&"function"==typeof H.type&&"function"==typeof(i=H.type()).setFillStyle&&i.setFillStyle($.group,e),e.fill(),e.restore(),e.fillStyle="#000000",e.globalAlpha=1,!e.drawHTML($.content,$.x1+2,$.y1,$.style))return void setTimeout(function(t){return function(){var e;return null!=(e=t.editor.Overlay)?e.redrawContents():void 0}}(this),10);this.bubbleTags.unshift($)}if(R=3,!this.groupUnderMouse||p(this.groupUnderMouse,!1,!0,!1)){for(V=function(e,n){return{left:{x:e.left,y:e.top},right:{x:e.top===n.top&&e.bottom===n.bottom?n.right:t.width-z,y:e.top}}},l=function(t,e){return{left:{x:t.top===e.top&&t.bottom===e.bottom?t.left:x,y:e.bottom},right:{x:e.right,y:e.bottom}}},20,m=function(t,e){return t.close.bottom+20<e.open.top?{from:l(t.open,t.close),to:V(e.open,e.close),startDir:1,endDir:1}:e.close.bottom+20<t.open.top?{from:V(t.open,t.close),to:l(e.open,e.close),startDir:-1,endDir:-1}:{from:V(t.open,t.close),to:V(e.open,e.close),startDir:-1,endDir:1}},b=function(t,e,n,o){var i;return i=(n+1)/(o+1),e=Math.min(e,t+40*o),(1-i)*t+i*e},d=function(t){return function(n,o,i,r,s,l){var a,u,c,d,p,h,f,g,y,v,w,C,x;if(e.save(),e.strokeStyle=(null!=(f=i.type())?f.color:void 0)||"#444444",e.globalAlpha=1,e.lineWidth=2,"function"==typeof l&&l(e),p=i.getScreenBoundaries(),x=r.getScreenBoundaries(),p&&x){if(p.open.top-=R,p.close.top-=R,p.open.bottom+=R,p.close.bottom+=R,x.open.top-=R,x.close.top-=R,x.open.bottom+=R,x.close.bottom+=R,h=m(p,x),v=b(h.from.left.x,h.from.right.x,n,o),w=h.from.left.y,c=b(h.to.left.x,h.to.right.x,n,o),d=h.to.left.y,e.bezierArrow(v,w,v,w+20*h.startDir,c,d-20*h.endDir,c,d),e.stroke(),""!==s){if(a=e.applyBezier(v,v,c,c,.5),u=e.applyBezier(w,w+20*h.startDir,d-20*h.endDir,d,.5),C=createFontStyleString(i.open),!(q=e.measureHTML(s,C)))return void setTimeout(function(){var e;return null!=(e=t.editor.Overlay)?e.redrawContents():void 0},10);e.roundedRect(a-q.width/2-2,u-q.height/2-2,a+q.width/2+2,u+q.width/2,4),e.globalAlpha=1,e.fillStyle="#ffffff",e.fill(),e.lineWidth=1.5,e.strokeStyle=null!=(g=null!=(y=i.type())?y.color:void 0)?g:"#444444",e.stroke(),e.fillStyle="#000000",e.globalAlpha=1,e.drawHTML(s,a-q.width/2+2,u-q.height/2,C)}return e.restore()}}}(this),_=[],A=0,S=(W=[g].concat(slice.call(null!=(j="function"==typeof this.visibleGroups?this.visibleGroups():void 0)?j:[]))).length;A<S;A++)if(f=W[A]){for(c="function"==typeof(r=f.type()).connections?r.connections(f):void 0,L=function(){var t,e,n;for(n=[],e=0,t=c.length;e<t;e++)(a=c[e])instanceof Array&&n.push(a);return n}().length,B=0,M=(J=null!=c?c:[]).length;B<M;B++)(u=J[B])instanceof Array||("number"==typeof u&&(u=this[u]),p(u,!0,!1,!1));_.push(function(){var t,e,n,o;for(o=[],y=e=0,t=(n=null!=c?c:[]).length;e<t;y=++e)(u=n[y])instanceof Array?(h="number"==typeof u[0]?this[u[0]]:u[0],X="number"==typeof u[1]?this[u[1]]:u[1],o.push(d.apply(null,[y,L,h,X].concat(slice.call(u.slice(2)))))):o.push(void 0);return o}.call(this))}else _.push(void 0);return _}}},t}(),styleSheet="img.grouper { margin-bottom : -0.35em; cursor : default; } img.grouper.hide:not(.decorate) { width : 0px; height : 22px; }",styleSheetURL="data:text/css;base64,"+btoa(styleSheet),tinymce.PluginManager.add("groups",function(t,e){var n,o,i,r;for(t.Groups=new Groups(t),t.Groups.styleSheet=styleSheet,t.on("init",function(e){var n,o;return n=t.getDoc().getElementsByTagName("head")[0],(o=t.getDoc().createElement("link")).setAttribute("rel","stylesheet"),o.setAttribute("href",styleSheetURL),n.appendChild(o)}),n=0,o=(i=t.settings.groupTypes).length;n<o;n++)r=i[n],t.Groups.addGroupType(r.name,r);return t.addMenuItem("hideshowgroups",{text:"Hide/show groups",context:"View",onclick:function(){return t.Groups.hideOrShowGroupers()}}),window.useGroupConnectionsUI&&t.addButton("connect",{image:htmlToImage("&#x2197;"),tooltip:"Connect groups",onclick:function(){return this.active(!this.active()),t.Groups.updateConnectionsMode()},onPostRender:function(){return t.Groups.connectionsButton=this,t.Groups.updateButtonsAndMenuItems()}}),t.on("change SetContent",function(e){var n,o,i;if(t.Groups.scanDocument(),null!=e&&null!=(i=e.level)?i.bookmark:void 0)return n=t.selection.getBookmark(),t.selection.moveToBookmark(e.level.bookmark),o=t.selection.getRng(),t.selection.moveToBookmark(n),t.Groups.rangeChanged(o)}),t.on("KeyUp",function(e){var n,o,i,r;if(o=[33,34,35,36,37,38,39,40],n=[16,17,18,91],i=e.keyCode,!(indexOf.call(o,i)>=0||(r=e.keyCode,indexOf.call(n,r)>=0)))return t.Groups.scanDocument(),t.Groups.rangeChanged(t.selection.getRng())}),t.on("NodeChange",function(e){return t.Groups.updateButtonsAndMenuItems()}),t.on("contextMenu",function(e){var n,o,i,r,s,l,a,u,c,d,p,h,f,g;for(e.preventDefault(),f=e.clientX,g=e.clientY,(c=t.getDoc().nodeFromPoint(f,g))&&(n=t.Groups.groupAboveNode(c)),i=[],r=0,s=(p=(t.settings.contextmenu||"link image inserttable | cell row column deletetable").split(/[ ,]/)).length;r<s;r++)a=p[r],o=t.menuItems[a],"|"===a&&(o={text:a}),o&&(o.shortcut="",i.push(o));return(u=null!=n&&null!=(h=n.type())?h.contextMenuItems(n):void 0)&&(i.push({text:"|"}),i=i.concat(u)),l=new tinymce.ui.Menu({items:i,context:"contextmenu",classes:"contextmenu"}).renderTo(),t.on("remove",function(){return l.remove(),l=null}),d=$(t.getContentAreaContainer()).position(),l.moveTo(f+d.left,g+d.top)}),t.on("mousedown",function(e){var n,o,i,r,s,l,a,u,c,d,p,h,f,g,m,y,v,b,w,C,x,k;if(x=e.clientX,k=e.clientY,null!=(p=t.Groups.connectionsButton)&&p.active()){if(r=t.groupUnderMouse(x,k)){if(!(l=null!=(h=t.selection)&&null!=(f=h.getRng())?f.cloneRange():void 0))return;return l.collapse(!0),n=t.Groups.groupAboveCursor(l),null!=(g=n.type())&&"function"==typeof g.connectionRequest&&g.connectionRequest(n,r),e.preventDefault(),null!=(m=t.Groups.connectionsButton)&&m.active(!1),t.Groups.updateConnectionsMode(),!1}}else{if(o=t.getDoc(),(i=o.elementFromPoint(x,k))&&grouperInfo(i))return r=t.Groups.grouperToGroup(i),null!=(y=r.type())&&"function"==typeof y.clicked&&y.clicked(r,"single",i===r.open?"open":"close"),!1;for(s=0,a=(v=t.Groups.bubbleTags).length;s<a;s++)if((C=v[s]).x1<x&&x<C.x2&&C.y1<k&&k<C.y2)return null==(c=null!=(b=C.group)&&null!=(w=b.type())?w.tagMenuItems(C.group):void 0)&&(c=[{text:"no actions available",disabled:!0}]),u=new tinymce.ui.Menu({items:c,context:"contextmenu",classes:"contextmenu"}).renderTo(),t.on("remove",function(){return u.remove(),u=null}),d=$(t.getContentAreaContainer()).position(),u.moveTo(x+d.left,k+d.top),e.preventDefault(),!1}}),t.on("dblclick",function(e){var n,o,i,r;if(n=t.getDoc(),(o=n.elementFromPoint(e.clientX,e.clientY))&&grouperInfo(o))return i=t.Groups.grouperToGroup(o),null!=(r=i.type())&&"function"==typeof r.clicked&&r.clicked(i,"double",o===i.open?"open":"close"),!1}),t.on("mousemove",function(e){var n;return t.Groups.groupUnderMouse=t.groupUnderMouse(e.clientX,e.clientY),null!=(n=t.Overlay)?n.redrawContents():void 0}),t.groupUnderMouse=function(e,n){var o,i,r,s,l,a,u,c,d,p,h;for(i=(o=t.getDoc()).elementFromPoint(e,n),r=s=0,h=i.childNodes.length;0<=h?s<h:s>h;r=0<=h?++s:--s)if(3===(u=i.childNodes[r]).nodeType)for((c=o.createRange()).selectNode(u),p=c.getClientRects(),p=function(){var t,e,n;for(n=[],r=t=0,e=p.length;0<=e?t<e:t>e;r=0<=e?++t:--t)n.push(p[r]);return n}(),a=0,l=p.length;a<l;a++)if(d=p[a],e>d.left&&e<d.right&&n>d.top&&n<d.bottom)return t.Groups.groupAboveNode(u);return null},t.on("KeyUp",function(e){var n,o,i,r,s,l,a,u,c,d,p,h,f,g,m,y;if(l=[33,34,35,36,37,38,39,40],s=[16,17,18,91],c=e.keyCode,!(indexOf.call(l,c)>=0||(d=e.keyCode,indexOf.call(s,d)>=0))&&(u=t.selection.getRng()).startContainer===u.endContainer&&3===(null!=(p=u.startContainer)?p.nodeType:void 0)){if(i=u.startContainer.textContent," "!==(r=i[u.startOffset-1])&&"\\"!==r&&r!==String.fromCharCode(160))return;o=i.substr(0,u.startOffset-1),n=i.substring(u.startOffset-1),h=t.Groups.groupTypes,f=[];for(y in h)if(m=h[y],g=m.LaTeXshortcut){if(o.slice(-g.length)===g){a=u.startOffset-g.length-1,"\\"!==r&&(n=n.substr(1)),o=o.slice(0,-g.length),u.startContainer.textContent=o+n,u.setStart(u.startContainer,a),"\\"===r?u.setEnd(u.startContainer,a+1):u.setEnd(u.startContainer,a),t.selection.setRng(u),t.Groups.groupCurrentSelection(y);break}f.push(void 0)}else f.push(void 0);return f}})}),editor=null,setIndexPage=function(t){return editor.indexURL=t},getIndexPage=function(){return editor.indexURL},setAPIPage=function(t){return editor.APIURL=t},getAPIPage=function(){return editor.APIURL},getPageData=function(t,e,n){var o;return(o=new XMLHttpRequest).addEventListener("load",function(){var t,o,i;o=this.responseText;try{i=JSON.parse(o)}catch(t){return t,void n(null,"Invalid response format.\nShould be JSON:\n"+o)}try{t=i.query.pages[0].revisions[0][e]}catch(t){return t,void n(null,"No such page on wiki.\nRaw reply:\n"+o)}return n(t,null)}),o.open("GET",editor.MediaWiki.getAPIPage()+"?action=query&titles="+encodeURIComponent(t)+"&prop=revisions&rvprop="+e+"&rvparse&format=json&formatversion=2"),o.setRequestHeader("Api-User-Agent","Lurch application"),o.send()},getPageContent=function(t,e){return getPageData(t,"content",e)},getPageTimestamp=function(t,e){return getPageData(t,"timestamp",e)},importPage=function(t,e){return editor.MediaWiki.getPageContent(t,function(t,n){var o,i,r;return n&&(editor.Dialogs.alert({title:"Wiki Error",message:"<p>Error loading content from wiki:</p> <p>"+n.split("\n")[0]+"</p>"}),console.log(n),"function"==typeof e&&e(!1)),r=editor.Storage.extractMetadata(t),i=r.metadata,o=r.document,null==i&&(editor.Dialogs.alert({title:"Not a Lurch document",message:"<p><b>The wiki page that you attempted to import is not a Lurch document.</b></p> <p>Although it is possible to import any wiki page into Lurch, it does not work well to edit and re-post such pages to the wiki.</p> <p>To edit a non-Lurch wiki page, visit the page on the wiki and edit it there.</p>"}),"function"==typeof e&&e(!1)),editor.setContent(o),"function"==typeof e?e(o,i):void 0})},getPageMetadata=function(t,e){return editor.MediaWiki.getPageContent(t,function(t,n){return"function"==typeof e?e(n?null:editor.Storage.extractMetadata(t).metadata):void 0})},login=function(t,e,n,o){var i,r;return(r=new XMLHttpRequest).addEventListener("load",function(){var o,i,r,s,l;o=this.responseText;try{i=JSON.parse(o)}catch(t){return t,void n(null,"Invalid JSON response: "+o)}return"Success"===(null!=i&&null!=(r=i.login)?r.result:void 0)?n(!0,null):"NeedToken"===(null!=i&&null!=(s=i.login)?s.result:void 0)?editor.MediaWiki.login(t,e,n,i.login.token):n(null,"Login error of type "+(null!=i&&null!=(l=i.login)?l.result:void 0))}),i=editor.MediaWiki.getAPIPage()+"?action=login&lgname="+encodeURIComponent(t)+"&lgpassword="+encodeURIComponent(e)+"&format=json&formatversion=2",o&&(i+="&lgtoken="+o),r.open("POST",i),r.setRequestHeader("Api-User-Agent","Lurch application"),r.send()},exportPage=function(t,e,n){var o;return(o=new XMLHttpRequest).addEventListener("load",function(){var o,i,r,s,l,a,u;i=this.responseText;try{r=JSON.parse(i)}catch(t){return o=t,void n(null,"Invalid JSON response: "+i)}{if(null!=r&&null!=(s=r.query)&&null!=(l=s.tokens)?l.csrftoken:void 0)return(u=new XMLHttpRequest).addEventListener("load",function(){var t;i=this.responseText;try{r=JSON.parse(i)}catch(t){return o=t,void n(null,"Invalid JSON response: "+i)}{if("Success"===(null!=r&&null!=(t=r.edit)?t.result:void 0))return n("Success",null);n(null,"Edit failed: "+i)}}),e=formatContentForWiki(e),u.open("POST",editor.MediaWiki.getAPIPage()+"?action=edit&title="+encodeURIComponent(t)+"&text="+encodeURIComponent(e)+"&summary="+encodeURIComponent("posted from Lurch")+"&contentformat="+encodeURIComponent("text/x-wiki")+"&contentmodel="+encodeURIComponent("wikitext")+"&format=json&formatversion=2",!0),a="token="+encodeURIComponent(r.query.tokens.csrftoken),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.setRequestHeader("Api-User-Agent","Lurch application"),u.send(a);n(null,"No token provided: "+i)}}),o.open("GET",editor.MediaWiki.getAPIPage()+"?action=query&meta=tokens&format=json&formatversion=2"),o.setRequestHeader("Api-User-Agent","Lurch application"),o.send()},formatContentForWiki=function(t){var e,n,o,i,r,s,l,a,u;for(l="",i=0,s=/^<([^ >]+)\s*([^>]+)?>/i,n=/^<\/([^ >]+)\s*>/i,e=/^&([a-z0-9]+|#[0-9]+);/i,u=["img","span","var","sup"],o=document.createElement("div");t.length>0;)(r=n.exec(t))?(a=r[1].toLowerCase(),indexOf.call(u,a)>=0?l+="</htmltag"+--i+">":l+=r[0],t=t.slice(r[0].length)):(r=s.exec(t))?(a=r[1].toLowerCase(),indexOf.call(u,a)>=0?(l+="<htmltag"+i+" tagname='"+a+"' "+r[2]+">",/\/\s*$/.test(r[2])||i++):l+=r[0],t=t.slice(r[0].length)):(r=e.exec(t))?(o.innerHTML=r[0],l+=o.textContent,t=t.slice(r[0].length)):(l+=t[0],t=t.slice(1));return l},tinymce.PluginManager.add("mediawiki",function(t,e){return(editor=t).MediaWiki={setIndexPage:setIndexPage,getIndexPage:getIndexPage,setAPIPage:setAPIPage,getAPIPage:getAPIPage,login:login,getPageContent:getPageContent,getPageTimestamp:getPageTimestamp,importPage:importPage,exportPage:exportPage,getPageMetadata:getPageMetadata}}),Overlay=function(){function t(t){this.editor=t,this.redrawContents=bind(this.redrawContents,this),this.editor.on("init",function(t){return function(){return t.container=t.editor.getContentAreaContainer(),t.canvas=document.createElement("canvas"),$(t.container).after(t.canvas),t.canvas.style.position="absolute",t.canvas.style["background-color"]="rgba(0,0,0,0)",t.canvas.style["pointer-events"]="none",t.canvas.style["z-index"]="10"}}(this)),this.drawHandlers=[],this.editor.on("NodeChange",this.redrawContents),$(this.editor.getContentAreaContainer()).resize(this.redrawContent)}return t.prototype.redrawContents=function(t){var e,n,o,i,r,s,l,a;if(this.positionCanvas(),e=null!=(s=this.canvas)?s.getContext("2d"):void 0){for(this.clearCanvas(e),e.translate(0,$(this.container).position().top),l=this.drawHandlers,a=[],i=0,r=l.length;i<r;i++){n=l[i];try{a.push(n(this.canvas,e))}catch(t){o=t,a.push(console.log("Error in overlay draw function: "+o.stack))}}return a}},t.prototype.addDrawHandler=function(t){return this.drawHandlers.push(t)},t.prototype.getEditorFrame=function(){var t,e,n,o;for(e=0,n=(o=window.frames).length;e<n;e++)if((t=o[e]).document===this.editor.getDoc())return t;return null},t.prototype.positionCanvas=function(){var t,e;if(e=$(this.container),t=$(this.canvas),null!=e.position())return t.css("top",0),t.css("left",e.position().left),t.width(e.width()),t.height(e.position().top+e.height()),this.canvas.width=t.width(),this.canvas.height=t.height()},t.prototype.clearCanvas=function(t){return t.clearRect(0,0,this.canvas.width,this.canvas.height)},t}(),tinymce.PluginManager.add("overlay",function(t,e){return t.Overlay=new Overlay(t),t.on("init",function(e){return $(t.getWin()).scroll(function(){return t.Overlay.redrawContents()})})}),(plugin={}).addCategory=function(t){return plugin[t]={get:function(t){return window.localStorage.getItem(t)},set:function(t,e){return window.localStorage.setItem(t,e)},setup:function(t){return null},teardown:function(t){return null},showUI:function(){return plugin.showUI(t)}}},plugin.showUI=function(t){var e,n,o,i;return o=null,e=[{type:"button",text:"Cancel",onclick:function(t){return tinymce.activeEditor.windowManager.close()}},{type:"button",text:"Save",subtype:"primary",onclick:function(e){return plugin[t].teardown(o),tinymce.activeEditor.windowManager.close()}}],n=t[0].toUpperCase()+t.slice(1).toLowerCase()+" Settings",tinymce.activeEditor.windowManager.open({title:n,url:"about:blank",width:500,height:400,buttons:e}),i=tinymce.activeEditor.windowManager.windows,o=i[i.length-1].getEl().getElementsByClassName("mce-container-body")[0],o.innerHTML="",plugin[t].setup(o)},plugin.UI={},plugin.UI.info=function(t,e){return plugin.UI.tr("<td style='width: 100%; text-align: center; white-space: normal;' >"+t+"</td>",e)},plugin.UI.heading=function(t,e){return plugin.UI.info("<hr style='border: 1px solid black;'> <span style='font-size: 20px;'>"+t+"</span> <hr style='border: 1px solid black;'>",e)},plugin.UI.readOnly=function(t,e,n){return plugin.UI.tpair(t,e,n)},plugin.UI.text=function(t,e,n){return plugin.UI.tpair(t,"<input type='text' id='"+e+"' value='"+n+"' style='border-width: 2px; border-style: inset;'/>")},plugin.UI.password=function(t,e,n){return plugin.UI.tpair(t,"<input type='password' id='"+e+"' value='"+n+"' style='border-width: 2px; border-style: inset;'/>")},plugin.UI.checkbox=function(t,e,n,o){var i;return null==e&&(e=!1),e=e?" checked":"",i=plugin.UI.generalPair("<input type='checkbox' id='"+n+"' "+e+"/>","<b>"+t+"</b>",null,10),o&&(i+=plugin.UI.generalPair("","<p>"+o+"</p>",null,10)),i},plugin.UI.radioButton=function(t,e,n,o,i){var r;return null==n&&(n=!1),n=n?" checked":"",r=plugin.UI.generalPair("<input type='radio' name='"+e+"' id='"+o+"' "+n+"/>","<b>"+t+"</b>",null,10),i&&(r+=plugin.UI.generalPair("","<p>"+i+"</p>",null,10)),r},plugin.UI.button=function(t,e){return"<input type='button' "+(null!=e?" id='"+e+"'":"")+" value='"+t+"' style='border: 1px solid #999999; background: #dddddd; padding: 2px; margin: 2px;' onmouseover='this.style.background=\"#eeeeee\";' onmouseout='this.style.background=\"#dddddd\";'/>"},plugin.UI.tr=function(t,e){return"<table border=0 cellpadding=0 cellspacing=10 style='width: 100%;' "+(null!=e?" id='"+e+"'":"")+"> <tr style='width: 100%; vertical-align: middle;'>"+t+"</tr></table>"},plugin.UI.tpair=function(t,e,n){return plugin.UI.tr("<td style='width: 50%; text-align: right; vertical-align: middle;'><b>"+t+":</b></td> <td style='width: 50%; text-align: left; vertical-align: middle;'>"+e+"</td>",n)},plugin.UI.generalPair=function(t,e,n,o,i){return null==i&&(i="left"),plugin.UI.tr("<td style='width: "+o+"%; text-align: "+i+"; vertical-align: middle;'>"+t+"</td> <td style='width: "+(100-o)+"%; text-align: left; vertical-align: middle;'>"+e+"</td>",n)},tinymce.PluginManager.add("settings",function(t,e){return t.Settings=plugin}),Storage=function(){function t(e){var n;this.editor=e,this.directWrite=bind(this.directWrite,this),this.directRead=bind(this.directRead,this),this.handleOpen=bind(this.handleOpen,this),this.tryToOpen=bind(this.tryToOpen,this),this.loadIntoEditor=bind(this.loadIntoEditor,this),this.tryToClear=bind(this.tryToClear,this),this.clear=bind(this.clear,this),this.getFilename=bind(this.getFilename,this),this.setLastFileObject=bind(this.setLastFileObject,this),this.setBackend=bind(this.setBackend,this),this.getBackend=bind(this.getBackend,this),this.availableBackends=bind(this.availableBackends,this),this.setAppName=bind(this.setAppName,this),this.setDocumentDirty=bind(this.setDocumentDirty,this),this.recomputePageTitle=bind(this.recomputePageTitle,this),this.setAppName(t.prototype.appName),this.backends={"browser storage":new LocalStorageFileSystem,Dropbox:new DropboxFileSystem("7mfyk58haigi2c4")},this.setBackend("browser storage"),this.setLastFileObject(null),setTimeout(function(t){return function(){return t.clear()}}(this),0),this.saveMetaData=this.loadMetaData=null,this.editor.on("change",function(t){return function(e){return t.setDocumentDirty(!0)}}(this)),(n=function(t){return function(e,n){var o,i;return o={icon:n.icon,shortcut:n.shortcut,onclick:n.onclick,tooltip:n.tooltip},i=null!=n.icon?"icon":"text",o[i]=n[i],t.editor.addButton(e,o),t.editor.addMenuItem(e,n)}}(this))("newfile",{text:"New",icon:"newdocument",context:"file",shortcut:"meta+alt+N",tooltip:"New file",onclick:function(t){return function(){return t.tryToClear()}}(this)}),n("savefile",{text:"Save",icon:"save",context:"file",shortcut:"meta+S",tooltip:"Save file",onclick:function(t){return function(){return t.tryToSave()}}(this)}),this.editor.addMenuItem("saveas",{text:"Save as...",context:"file",shortcut:"meta+shift+S",onclick:function(t){return function(){return t.tryToSave(null,!0)}}(this)}),n("openfile",{text:"Open...",icon:"browse",context:"file",shortcut:"meta+O",tooltip:"Open file...",onclick:function(t){return function(){return t.handleOpen()}}(this)}),t.prototype.instances.push(this)}return t.prototype.appName=null,t.setAppName=function(e){var n,o,i,r,s;for(null==e&&(e=null),t.prototype.appName=e,s=[],o=0,i=(r=t.prototype.instances).length;o<i;o++)n=r[o],s.push(n.setAppName(e));return s},t.prototype.instances=[],t.prototype.recomputePageTitle=function(){return document.title=(this.appName?this.appName+": ":"")+" "+(this.getFilename()||"(untitled)")+" "+(this.documentDirty?"*":"")},t.prototype.setDocumentDirty=function(t){return null==t&&(t=!0),this.documentDirty=t,this.recomputePageTitle()},t.prototype.setAppName=function(t){return null==t&&(t=null),this.appName=t,this.recomputePageTitle()},t.prototype.availableBackends=function(){return Object.keys(this.backends)},t.prototype.getBackend=function(){return this.backend},t.prototype.setBackend=function(t){if(indexOf.call(this.availableBackends(),t)>=0)return this.backend=t,window.setFileSystem(this.backends[this.backend])},t.prototype.setLastFileObject=function(t){return this.lastFileObject=t,this.recomputePageTitle()},t.prototype.getFilename=function(){var t,e,n;return null!=(t=this.lastFileObject)&&null!=(e=t.path)&&null!=(n=e.slice())?n.pop():void 0},t.prototype.embedMetadata=function(t,e){return null==e&&(e={}),"<span id='metadata' style='display: none;' >"+encodeURIComponent(JSON.stringify(e))+"</span>"+t},t.prototype.extractMetadata=function(t){var e,n;return n=/^<span[^>]+id=.metadata.[^>]*>([^<]*)<\/span>/,(e=n.exec(t))?{metadata:JSON.parse(decodeURIComponent(e[1])),document:t.slice(e[0].length)}:{metadata:null,document:t}},t.prototype.addLoadingScript=function(t){var e;return e=window.location.href.split("?")[0],'<div id="EmbeddedLurchDocument">'+t+"</div>\n<script>\n    elt = document.getElementById( 'EmbeddedLurchDocument' );\n    window.location.href = '"+e+"'\n      + '?document=' + encodeURIComponent( elt.innerHTML );\n<\/script>"},t.prototype.removeLoadingScript=function(t){var e,n,o;return o='<div id="EmbeddedLurchDocument">',"</div>",n=t.indexOf(o),e=t.lastIndexOf("</div>"),t.slice(n+o.length,e)},t.prototype.clear=function(){return this.editor.setContent(""),this.editor.undoManager.clear(),this.setDocumentDirty(!1),"function"==typeof this.loadMetaData?this.loadMetaData({}):void 0},t.prototype.tryToClear=function(){return this.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return t.tryToSave(function(e){if(e)return t.clear()}),t.editor.windowManager.close()}}(this)},{text:"Discard",onclick:function(t){return function(){return t.clear(),t.editor.windowManager.close()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):(this.clear(),void this.editor.focus())},t.prototype.tryToSave=function(t,e){var n,o;return null==e&&(e=!1),n=this.editor.getContent(),n=this.embedMetadata(n,"function"==typeof this.saveMetaData?this.saveMetaData():void 0),n=this.addLoadingScript(n),!e&&this.lastFileObject?(o=this.lastFileObject.path.slice().pop(),this.editor.Dialogs.waiting({title:"Saving file",message:"Please wait...",work:function(t){return function(e){return t.lastFileObject.update(n,function(n){return t.setDocumentDirty(!1),e()},function(n){return e(),t.editor.Dialogs.alert({title:"Error saving file",message:"<h1>File not saved!</h1> <p>File NOT saved to "+t.backend+":<br> "+o+"</p> <p>Reason: "+n+"</p>"})})}}(this)})):window.saveFile(function(t){return function(e){return t.setLastFileObject(e),o=t.lastFileObject.path.slice().pop(),t.editor.Dialogs.waiting({title:"Saving file",message:"Please wait...",work:function(i){return e.update(n,function(e){return i(),t.setDocumentDirty(!1)},function(e){return i(),t.editor.Dialogs.alert({title:"Error saving file",message:"<h1>File not saved!</h1> <p>File NOT saved to "+t.backend+":<br> "+o+"</p> <p>Reason: "+e+"</p>"})})}})}}(this))},t.prototype.loadIntoEditor=function(t){var e,n,o;return t=this.removeLoadingScript(t),o=this.extractMetadata(t),e=o.document,n=o.metadata,this.editor.setContent(e),this.editor.undoManager.clear(),this.editor.focus(),this.setDocumentDirty(!1),"function"==typeof this.loadMetaData?this.loadMetaData(null!=n?n:{}):void 0},t.prototype.tryToOpen=function(t){return null==t&&(t=function(t){return function(e){return t.loadIntoEditor(e)}}(this)),window.openFile(function(t){return function(e){var n;return t.setLastFileObject(e),n=function(t){return function(){var e;return e=1<=arguments.length?slice.call(arguments,0):[],setTimeout(function(){return t.apply(null,e)},0)}},t.editor.Dialogs.waiting({title:"Loading file",message:"Please wait...",work:n(function(n){return e.get(function(e){return t.loadIntoEditor(e),n()},function(e){return t.setLastFileObject(null),n(),t.editor.Dialogs.alert({title:"File load error",message:"<h1>Error loading file</h1> <p>The file failed to load from "+t.backend+", with an error of type "+e+".</p>"})})})})}}(this))},t.prototype.handleOpen=function(){return this.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return t.editor.windowManager.close(),t.tryToSave(function(e){if(e)return t.tryToOpen()})}}(this)},{text:"Discard",onclick:function(t){return function(){return t.editor.windowManager.close(),t.tryToOpen()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):this.tryToOpen()},t.prototype.directRead=function(t,e,n,o){var i;return null!=(i=this.backends[t])?i.readFile(e,n,o):void 0},t.prototype.directWrite=function(t,e,n,o,i){var r;return null!=(r=this.backends[t])?r.writeFile(e,n,o,i):void 0},t}(),tinymce.PluginManager.add("storage",function(t,e){return t.Storage=new Storage(t)}),window.setAppName=function(t){return null==t&&(t=null),Storage.prototype.appName=t},keyboardShortcutsWorkaround=function(t){var e,n,o;return o=[],e=function(t){var e,n,o,i;return i=t.toLowerCase().replace(/\s+/g,"").split("+"),o=2<=i.length?slice.call(i,0,e=i.length-1):(e=0,[]),n=i[e++],{altKey:indexOf.call(o,"alt")>=0,ctrlKey:indexOf.call(o,"ctrl")>=0,metaKey:indexOf.call(o,"meta")>=0,key:n}},n=function(n,i){var r;if(null!=(null!=i?i.shortcut:void 0)&&"cut"!==n&&"copy"!==n&&"paste"!==n)return o.push({keys:e(i.shortcut),action:null!=(r=i.onclick)?r:function(){return t.execCommand(n)}})},t.__addMenuItem=t.addMenuItem,t.addMenuItem=function(e,o){return n(e,o),t.__addMenuItem(e,o)},t.__addButton=t.addButton,t.addButton=function(e,o){return n(e,o),t.__addButton(e,o)},t.on("keydown",function(t){var e,n,i,r,s,l,a;for(e=0,i=o.length;e<i;e++){r=!0,s=(l=o[e]).keys;for(n in s)if(hasProp.call(s,n)&&(a=s[n],t[n]!==a)){r=!1;break}if(r)return t.preventDefault(),void l.action()}})},maybeSetupTestRecorder=function(){var t,e,n;if("?test"===location.search)return(n=open("./testrecorder.html","recording","status=no, location=no, toolbar=no, menubar=no, left="+(window.screenX+$(window).width())+", top="+window.screenY+", width=400, height=600"))||alert("You have asked to run Lurch in test-recording mode, which requires a popup window.  Your browser has blocked the popup window.  Change its settings or allow this popup to use test-recording mode."),e=[],(t=function(){var o,i,r,s,l,a,u,c,d;u=function(t){return alert("You "+t+", which the test recorder does not yet support.  The current test has therefore become corrupted, and you should reload this page and start your test again.  You will need to limit yourself to using only supported keys, menu items, and mouse operations.")};try{if(indexOf.call(e,"keypress")<0&&(tinymce.activeEditor.on("keypress",function(t){var e;return e=String.fromCharCode(t.keyCode),/[A-Za-z0-9 ]/.test(e)?n.editorKeyPress(t.keyCode,t.shiftKey,t.ctrlKey,t.altKey):u("pressed the key with code "+t.keyCode)}),e.push("keypress")),indexOf.call(e,"keyup")<0&&(tinymce.activeEditor.on("keyup",function(t){var e,o,i,r;if(i=String.fromCharCode(t.keyCode),!(/[A-Za-z0-9 ]/.test(i)||(o=[16,17,18,91],r=t.keyCode,indexOf.call(o,r)>=0)))return(e={8:"backspace",13:"enter",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",46:"delete"}).hasOwnProperty(t.keyCode)?n.editorKeyPress(e[t.keyCode],t.shiftKey,t.ctrlKey,t.altKey):u("pressed the key with code "+t.keyCode)}),e.push("keyup")),indexOf.call(e,"click")<0&&(tinymce.activeEditor.on("click",function(t){return t.shiftKey?u("shift-clicked"):t.ctrlKey?u("ctrl-clicked"):t.altKey?u("alt-clicked"):n.editorMouseClick(t.clientX,t.clientY)}),e.push("click")),o=function(t){return Array.prototype.slice.apply(tinymce.activeEditor.theme.panel.find(t))},indexOf.call(e,"buttons")<0){for(i=function(t){return t.on("click",function(){return n.buttonClicked(t.settings.icon)})},r=0,l=(c=o("button")).length;r<l;r++)i(c[r]);e.push("buttons")}for(s=0,a=(d=slice.call(o("splitbutton")).concat(slice.call(o("listbox")),slice.call(o("menubutton")))).length;s<a;s++)d[s].disabled(!0);return n.enterReadyState()}catch(e){return e,setTimeout(t,100)}})()},setAppName("Untitled"),null==window.groupTypes&&(window.groupTypes=[{name:"example",text:"Example group",imageHTML:"[",openImageHTML:"]",closeImageHTML:"[]",tooltip:"Wrap text in a group",color:"#666666"}]),null==window.groupToolbarButtons&&(window.groupToolbarButtons={}),null==window.groupMenuItems&&(window.groupMenuItems={}),null==window.pluginsToLoad&&(window.pluginsToLoad=[]),window.fullScreenEditor=!0,window.editorContainer=null,null==window.menuBarIcon&&(window.menuBarIcon={}),null==window.defaultEditorStyles&&(window.defaultEditorStyles={fontSize:"16px",fontFamily:"Verdana, Arial, Helvetica, sans-serif"}),$(function(){var t,e,n;return(editor=document.createElement("textarea")).setAttribute("id","editor"),null==window.editorContainer&&(window.editorContainer=document.body),"function"==typeof window.editorContainer&&(window.editorContainer=window.editorContainer()),window.editorContainer.appendChild(editor),maybeSetupTestRecorder(),t=function(){var t,e,o,i;for(i=[],t=0,e=groupTypes.length;t<e;t++)(null==(o=(n=groupTypes[t]).onToolbar)||o)&&i.push(n.name);return i}(),tinymce.init({selector:"#editor",auto_focus:"editor",branding:!1,browser_spellcheck:!0,gecko_spellcheck:!0,statusbar:!1,paste_data_images:!0,plugins:"advlist table charmap colorpicker image link paste print searchreplace textcolor -storage -overlay -groups -dependencies -dialogs -downloadupload "+function(){var t,n,o,i;for(i=[],t=0,n=(o=window.pluginsToLoad).length;t<n;t++)e=o[t],i.push("-"+e);return i}().join(" ")+(window.fullScreenEditor?" fullscreen":""),object_resizing:":not(img.grouper)",toolbar:["newfile openfile savefile managefiles | print | undo redo | cut copy paste | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent blockquote | table","fontselect fontsizeselect styleselect | bold italic underline textcolor subscript superscript removeformat | link unlink | charmap image | spellchecker searchreplace | equationeditor | "+t.join(" ")+" connect"+moreToolbarItems()],fontsize_formats:"8pt 10pt 12pt 14pt 18pt 24pt 36pt",style_formats_merge:!0,style_formats:[{title:"Grading",items:[{title:"Red highlighter",inline:"span",styles:{"border-radius":"5px",padding:"2px 5px",margin:"0 2px",color:"#770000","background-color":"#ffaaaa"}},{title:"Yellow highlighter",inline:"span",styles:{"border-radius":"5px",padding:"2px 5px",margin:"0 2px",color:"#777700","background-color":"#ffffaa"}},{title:"Green highlighter",inline:"span",styles:{"border-radius":"5px",padding:"2px 5px",margin:"0 2px",color:"#007700","background-color":"#aaffaa"}},{title:"No highlighting",inline:"span",exact:!0}]}],menu:{file:{title:"File",items:"newfile openfile | savefile saveas download upload | managefiles | print"+moreMenuItems("file")},edit:{title:"Edit",items:"undo redo | cut copy paste pastetext | selectall"+moreMenuItems("edit")},insert:{title:"Insert",items:"link media | template hr | me"+moreMenuItems("insert")},view:{title:"View",items:"visualaid hideshowgroups"+moreMenuItems("view")},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"+moreMenuItems("format")},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"+moreMenuItems("table")},help:{title:"Help",items:"about tour website"+moreMenuItems("help")}},contextmenu:"link image inserttable | cell row column deletetable"+moreMenuItems("contextmenu"),groupTypes:groupTypes,setup:function(t){var e,n,o,i;keyboardShortcutsWorkaround(t),t.addMenuItem("about",{text:"About...",context:"help",onclick:function(){return t.Dialogs.alert({title:"Lurch",message:"undefined"!=typeof helpAboutText&&null!==helpAboutText?helpAboutText:""})}}),t.addMenuItem("tour",{text:"Take a tour",context:"help",onclick:function(){var t,e,n;return t=function(t){var e,n,o,i,r;for(r=function(t,e){return t.trim().toLowerCase()===e.trim().toLowerCase()},n=0,o=(i=document.getElementsByClassName("mce-menubtn")).length;n<o;n++)if(e=i[n],r(e.textContent,t))return e;return null},e=function(t){return document.getElementsByClassName("mce-i-"+t)[0]},(n=new Tour({storage:!1,steps:[{element:t("edit"),title:"Edit menu",content:"This tour is just an example for now.  Obviously you already knew where the edit menu was."},{element:e("table"),title:"Table maker",content:"Yes, you can make tables, too! Okay, that's enough of a fake tour. We'll add a real tour to the application later."}]})).init(),n.start()}}),t.addMenuItem("website",{text:"Documentation",context:"help",onclick:function(){return window.open("http://lurchmath.github.io","_blank")}}),o=window.groupMenuItems;for(n in o)hasProp.call(o,n)&&(e=o[n],t.addMenuItem(n,e));i=window.groupToolbarButtons;for(n in i)hasProp.call(i,n)&&(e=i[n],t.addButton(n,e));return t.on("init",function(){var e,n,o,i,r,s,l,a,u;installDOMUtilitiesIn(t.getWin()),r=window.defaultEditorStyles;for(i in r)hasProp.call(r,i)&&(u=r[i],t.getBody().style[i]=u);return setTimeout(function(){return t.execCommand("mceFullScreen")},0),indexOf.call(window.pluginsToLoad,"equationeditor")>=0&&t.dom.loadCSS("./eqed/mathquill.css"),null!=(null!=(s=window.menuBarIcon)?s.src:void 0)&&(e=t.getContainer().getElementsByClassName("mce-menubtn")[0],(o=document.createElement("img")).setAttribute("src",window.menuBarIcon.src),o.style.width=window.menuBarIcon.width,o.style.height=window.menuBarIcon.height,o.style.padding=window.menuBarIcon.padding,e.insertBefore(o,e.childNodes[0])),t.getBody().addEventListener("focus",function(){if(0!==t.windowManager.getWindows().length)return t.windowManager.close()}),t.on("KeyDown",function(e){if(9===e.keyCode)return e.preventDefault(),t.insertContent("&emsp;")}),window.addEventListener("beforeunload",function(e){if(t.Storage.documentDirty)return e.returnValue="You have unsaved changes.",e.returnValue}),"function"==typeof window.afterEditorReady&&window.afterEditorReady(t),n=null!=(l=t.Settings)&&null!=(a=l.application)?a.get("filesystem"):void 0,t.Storage.setBackend(null!=n?n:"browser storage")})}})}),moreMenuItems=function(t){var e,n;return(n=window.groupMenuItems.hasOwnProperty(t+"_order")?window.groupMenuItems[t+"_order"]:function(){var n,o,i,r;for(r=[],n=0,o=(i=Object.keys(window.groupMenuItems)).length;n<o;n++)e=i[n],window.groupMenuItems[e].context===t&&r.push(e);return r}().join(" ")).length&&"| "!==n.slice(0,2)?"| "+n:""},moreToolbarItems=function(){var t,e;return t=(null!=(e=window.groupToolbarButtons.order)?e:Object.keys(window.groupToolbarButtons)).join(" "),window.useGroupConnectionsUI&&(t="connect "+t),t.length&&"| "!==t.slice(0,2)?"| "+t:""},window.addHelpMenuSourceCodeLink=function(t){var e;return null==window.groupMenuItems&&(window.groupMenuItems={}),window.groupMenuItems.sourcecode={text:"View documented source code",context:"help",onclick:function(){return window.location.href="http://github.com/lurchmath/"+t}},e=function(t,n,o){if(!(t--<=0))return o.fadeOut(n).fadeIn(n,function(){return e(t,n,o)})},setTimeout(function(){return e(3,500,$(".mce-menubtn").filter(function(t,e){return"Help"===e.textContent.trim()}))},1e3)},window.showUndoStack=function(){var t,e,n,o,i,r,s,l,a;for(r=tinymce.activeEditor.undoManager,console.log("entry 0: document initial state"),a=[],n=i=1,l=r.data.length;1<=l?i<l:i>l;n=1<=l?++i:--i)if(s=r.data[n-1].content,t=r.data[n].content,s!==t){for(o=e=0;s.slice(0,+o+1||9e9)===t.slice(0,+o+1||9e9);)o++;for(;s.slice(s.length-e)===t.slice(t.length-e);)e++;a.push(console.log("entry "+n+": at "+o+": \n\torig: "+s.slice(o,+(s.length-e)+1||9e9)+" \n\tnow:  "+t.slice(o,+(t.length-e)+1||9e9)))}else console.log("entry "+n+": same as "+(n-1));return a};
//# sourceMappingURL=lurch-web-platform.js.map
