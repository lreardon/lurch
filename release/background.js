var BackgroundFunction,bind=function(n,r){return function(){return n.apply(r,arguments)}},hasProp={}.hasOwnProperty,slice=[].slice;window.Background={functions:{},registerFunction:function(n,r,i,t){return null==i&&(i={}),null==t&&(t=[]),window.Background.functions[n]={function:r,globals:i,scripts:t}},runningTasks:[],waitingTasks:[],addTask:function(n,r,i){var t,e,s,o,a,u,l,c,p,d,f,h,k;for(o=function(n){return n instanceof Group?n.id():JSON.stringify(n)},c={name:n,inputs:r,callback:i,id:n+","+function(){var n,i,t;for(t=[],n=0,i=r.length;n<i;n++)s=r[n],t.push(o(s));return t}()},e=t=0,u=(p=window.Background.waitingTasks).length;t<u;e=++t)if((k=p[e]).id===c.id){window.Background.waitingTasks.splice(e,1);break}for(e=a=0,l=(d=window.Background.runningTasks).length;a<l;e=++a)if((k=d[e]).id===c.id){null!=(f=k.runner)&&null!=(h=f.worker)&&"function"==typeof h.terminate&&h.terminate(),window.Background.runningTasks.splice(e,1);break}return window.Background.waitingTasks.push(c),window.Background.update()},addCodeTask:function(n,r,i,t,e){return null==t&&(t={}),null==e&&(e=[]),window.Background.registerFunction(""+n,n,t,e),window.Background.addTask(""+n,r,i)},available:{},update:function(){var n,r,i,t,e;for(n=window.Background;n.runningTasks.length<n.concurrency();){if(null==(e=n.waitingTasks.shift()))return;if(null==(t=null!=(i=n.available[e.name])?i.pop():void 0)){if(null==(r=n.functions[e.name]))continue;t=new BackgroundFunction(r.function,r.globals,r.scripts)}e.runner=t,n.runningTasks.push(e),function(r){var i;i=function(){var i,e,s;return e=n.runningTasks.indexOf(r),n.runningTasks.splice(e,1),(null!=(i=n.available)[s=r.name]?i[s]:i[s]=[]).push(t),window.Background.update()},t.call.apply(t,r.inputs).sendTo(function(n){return i(),"function"==typeof r.callback?r.callback(n):void 0}).orElse(i)}(e)}}},window.Background.concurrency=function(){var n;return Math.max(1,(null!=(n="undefined"!=typeof navigator&&null!==navigator?navigator.hardwareConcurrency:void 0)?n:1)-1)},BackgroundFunction=function(){function _Class(n,r,i){var t,e,s;if(this.function=n,this.globals=r,this.scripts=i,this.call=bind(this.call,this),this.promise={sendTo:function(n){return function(r){return n.promise.resultCallback=r,n.promise.hasOwnProperty("result")&&n.promise.resultCallback(n.promise.result),n.promise}}(this),orElse:function(n){return function(r){return n.promise.errorCallback=r,n.promise.hasOwnProperty("error")&&n.promise.errorCallback(n.promise.error),n.promise}}(this)},window.Worker){this.worker=new window.Worker("worker.js"),this.worker.addEventListener("message",function(n){return function(r){var i;return n.promise.result=r.data,null!=(i=n.promise)&&"function"==typeof i.resultCallback?i.resultCallback(r.data):void 0}}(this),!1),this.worker.addEventListener("error",function(n){return function(r){var i;return n.promise.error=r,null!=(i=n.promise)&&"function"==typeof i.errorCallback?i.errorCallback(r):void 0}}(this),!1),this.worker.postMessage({setFunction:""+this.function}),s=this.globals;for(e in s)hasProp.call(s,e)&&(t=s[e],this.globals[e]=""+t);this.worker.postMessage({install:this.globals}),this.worker.postMessage({import:this.scripts})}}return _Class.prototype.call=function(){var args,i,input,inputs,len;for(args=1<=arguments.length?slice.call(arguments,0):[],delete this.promise.result,delete this.promise.resultCallback,delete this.promise.error,delete this.promise.errorCallback,i=0,len=args.length;i<len;i++)if((input=args[i])instanceof Group&&input.deleted)return;return inputs=function(){var n,r,i;for(i=[],n=0,r=args.length;n<r;n++)(input=args[n])instanceof Group?i.push(input.toJSON()):i.push(input);return i}(),null!=this.worker?this.worker.postMessage({runOn:inputs}):setTimeout(function(_this){return function(){var base,base1,e;try{with(this.globals)_this.promise.result=_this.function.apply(_this,inputs)}catch(n){return e=n,_this.promise.error=e,void("function"==typeof(base=_this.promise).errorCallback&&base.errorCallback(_this.promise.error))}return"function"==typeof(base1=_this.promise).resultCallback?base1.resultCallback(_this.promise.result):void 0}}(this),0),this.promise},_Class}();
//# sourceMappingURL=background.js.map
